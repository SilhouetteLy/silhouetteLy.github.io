I"rÿ<h2 id="å‰è¨€">å‰è¨€</h2>

<p>ä¸€ç›´å¯¹Springçš„äº‹åŠ¡ç®¡ç†ç†è§£ä¸å¤Ÿé€æµ‹ï¼Œå¹¶ä¸”å¼€å‘æ—¶è€æ˜¯ä¼šå‡ºç°æŠ¥é”™åäº‹åŠ¡æœªå›æ»šçš„æƒ…å†µï¼Œæ­¤æ¬¡æ­£å¥½æœ‰æ—¶é—´æ•´ç†ä¸€ä¸‹ï¼Œå¥½å¥½çš„æŠŠSpringçš„äº‹åŠ¡ç®¡ç†çš„å®ç°ä¸äº‹åŠ¡å›æ»šå¼„æ¸…æ¥šã€‚ä»¥ä¸‹å†…å®¹è®¾è®¡åˆ°çš„å‚è€ƒèµ„æ–™æœ‰ï¼š</p>

<ul>
  <li><a href="https://blog.csdn.net/chinacr07/article/details/78817449">Springäº‹åŠ¡ç®¡ç†ä¹‹å‡ ç§æ–¹å¼å®ç°äº‹åŠ¡</a></li>
  <li><a href="https://blog.csdn.net/blueheart20/article/details/44654007?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4">Springä¸­@Transactionalç”¨æ³•æ·±åº¦åˆ†æä¹‹ä¸€</a></li>
  <li><a href="https://blog.csdn.net/mingyundezuoan/article/details/79017659">@Transactional</a></li>
  <li><a href="https://blog.csdn.net/bao19901210/article/details/41724355?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1">springäº‹ç‰©é…ç½®ï¼Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†å’ŒåŸºäº@Transactionalæ³¨è§£çš„ä½¿ç”¨</a></li>
  <li><a href="https://blog.csdn.net/trigl/article/details/50968079">Springäº‹åŠ¡ç®¡ç†ï¼ˆè¯¦è§£+å®ä¾‹ï¼‰</a></li>
  <li><a href="https://www.cnblogs.com/0201zcr/p/5962578.html">spring äº‹åŠ¡å›æ»š</a></li>
  <li><a href="https://www.cnblogs.com/zeng1994/p/8257763.html">æµ…è°ˆSpringä¸­çš„äº‹åŠ¡å›æ»š</a></li>
</ul>

<h2 id="ä¸€spring-ä¸­çš„äº‹åŠ¡ç®¡ç†">ä¸€ã€Spring ä¸­çš„äº‹åŠ¡ç®¡ç†</h2>

<h4 id="11-äº‹åŠ¡è®¤è¯†">1.1 äº‹åŠ¡è®¤è¯†</h4>

<ul>
  <li><code class="highlighter-rouge">äº‹åŠ¡(Transaction)</code>ï¼šå®ƒæ˜¯ä¸€äº›åˆ—ä¸¥å¯†æ“ä½œåŠ¨ä½œã€‚è¦ä¹ˆéƒ½æ“ä½œå®Œæˆï¼Œè¦ä¹ˆéƒ½ä¼šæ»šæ’¤é”€ã€‚Springäº‹åŠ¡ç®¡ç†åŸºäºåº•å±‚æ•°æ®åº“æœ¬èº«çš„äº‹åŠ¡å¤„ç†æœºåˆ¶ã€‚äº‹åŠ¡å…·å¤‡<code class="highlighter-rouge">ACID</code>å››ç§ç‰¹æ€§ï¼ŒACID æ˜¯Atomic(åŸå­æ€§)ã€Consistency(ä¸€è‡´æ€§)ã€Isolation(éš”ç¦»æ€§)å’ŒDurability(æŒä¹…æ€§)çš„è‹±æ–‡ç¼©å†™ã€‚
    <ol>
      <li>åŸå­æ€§(Atomicity)
        <ul>
          <li>äº‹åŠ¡æœ€åŸºæœ¬çš„æ“ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šç»“æŸåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«ä¼šæ»šåˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚</li>
        </ul>
      </li>
      <li>ä¸€è‡´æ€§(Consistency)
        <ul>
          <li>äº‹åŠ¡çš„ä¸€è‡´æ€§æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹ç‰©æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åæ•°æ®åº“éƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚å¦‚æœäº‹åŠ¡æˆåŠŸåœ°å®Œæˆï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­æ‰€æœ‰å˜åŒ–å°†æ­£å¸¸åœ°åº”ç”¨ï¼Œç³»ç»Ÿå¤„äºæœ‰æ•ˆçŠ¶æ€ã€‚å¦‚æœåœ¨äº‹åŠ¡ä¸­å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­çš„æ‰€æœ‰å˜åŒ–å°†è‡ªåŠ¨ä¼šæ»šã€‚</li>
        </ul>
      </li>
      <li>éš”ç¦»æ€§
        <ul>
          <li>äº‹åŠ¡çš„éš”ç¦»æ€§æŒ‡çš„æ˜¯åœ¨å…µæ³•ç¯å¢ƒä¸­ï¼Œå½“ä¸åŒçš„äº‹ç‰©åŒæ—¶æ“çºµç›¸åŒçš„æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹ç‰©éƒ½æœ‰å„è‡ªçš„å®Œæ•´æ•°æ®ç©ºé—´ã€‚ç”±å¹¶å‘äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹å¿…é¡»ä¸ä»»ä½•å…¶å®ƒå¹¶å‘äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹éš”ç¦»ã€‚äº‹åŠ¡æŸ¥çœ‹æ•°æ®æ›´æ–°æ—¶ï¼Œæ•°æ®æ‰€å¤„çš„çŠ¶æ€è¦ä¹ˆæ˜¯å¦ä¸€äº‹åŠ¡ä¿®æ”¹å®ƒä¹‹å‰çš„çŠ¶æ€ï¼Œè¦ä¹ˆæ˜¯å¦ä¸€äº‹åŠ¡ä¿®æ”¹å®ƒä¹‹åçš„çŠ¶æ€ï¼Œäº‹åŠ¡ä¸ä¼šæŸ¥çœ‹åˆ°ä¸­é—´çŠ¶æ€çš„æ•°æ®ã€‚</li>
        </ul>
      </li>
      <li>æŒä¹…æ€§
        <ul>
          <li>äº‹åŠ¡çš„æŒä¹…æ€§æŒ‡çš„æ˜¯åªè¦äº‹åŠ¡æˆåŠŸç»“æŸï¼Œå®ƒå¯¹æ•°æ®åº“æ‰€åšçš„æ›´æ–°å¿…é¡»æ°¸ä¹…ä¿å­˜ä¸‹æ¥ã€‚å³ä½¿å‘ç”Ÿç³»ç»Ÿå´©æºƒï¼Œé‡æ–°å¯åŠ¨æ•°æ®åº“ç³»ç»Ÿåï¼Œæ•°æ®åº“è¿˜èƒ½æ¢å¤åˆ°äº‹åŠ¡æˆåŠŸç»“æŸæ—¶çš„çŠ¶æ€ã€‚</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<h4 id="12-æ˜ç¡®spring-äº‹åŠ¡æ§åˆ¶">1.2 æ˜ç¡®Spring äº‹åŠ¡æ§åˆ¶</h4>

<ol>
  <li>JavaEE ä½“ç³»è¿›è¡Œåˆ†å±‚å¼€å‘ï¼Œäº‹åŠ¡å¤„ç†ä½äºä¸šåŠ¡å±‚ï¼ŒSpring æä¾›äº†åˆ†å±‚è®¾è®¡<code class="highlighter-rouge">ä¸šåŠ¡å±‚</code>çš„äº‹åŠ¡å¤„ç†è§£å†³æ–¹æ¡ˆ</li>
  <li>Spring æ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç»„äº‹åŠ¡æ§åˆ¶çš„æ¥å£ã€‚è¿™ç»„æ¥å£æ˜¯åœ¨ spring-tx.xxx.jarä¸­ã€‚</li>
  <li>Spring çš„äº‹åŠ¡æ§åˆ¶éƒ½æ˜¯åŸºäº AOP çš„ï¼Œå®ƒå³å¯ä»¥ä½¿ç”¨ç¼–ç¨‹çš„æ–¹å¼å®ç°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é…ç½®çš„æ–¹å¼å®ç°ã€‚</li>
</ol>

<h4 id="13-spring-ä¸­äº‹åŠ¡æ§åˆ¶çš„-apiä»‹ç»">1.3 Spring ä¸­äº‹åŠ¡æ§åˆ¶çš„ APIä»‹ç»</h4>

<p><code class="highlighter-rouge">Springæ‰€æœ‰çš„äº‹åŠ¡ç®¡ç†ç­–ç•¥ç±»éƒ½ç»§æ‰¿è‡ª org.springframework.transaction.platformTransactionManageræ¥å£</code></p>

<p><img src="/img/images/spring/05/01-spring-interface.png" alt="01-spring-interface" /></p>

<ul>
  <li>
    <p><code class="highlighter-rouge">PlatformTransactionManager</code>ï¼šæ­¤æ¥å£ä¸Š Spring çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œå®ƒé‡Œé¢æä¾›äº†æˆ‘ä»¬å¸¸ç”¨çš„æ“ä½œäº‹åŠ¡çš„æ–¹æ³•</p>

    <ul>
      <li><code class="highlighter-rouge">TransactionStatus getTransaction(TransactionDefinition definition)</code>ï¼šè·å–äº‹åŠ¡çŠ¶æ€ä¿¡æ¯</li>
      <li><code class="highlighter-rouge">void commit(TransactionStatus status)</code>ï¼šæäº¤äº‹åŠ¡</li>
      <li><code class="highlighter-rouge">void rollback(TransactionStatus staus)</code>ï¼›å›æ»šäº‹åŠ¡</li>
    </ul>

    <blockquote>
      <p>æˆ‘ä»¬åœ¨å¼€å‘ä¸­éƒ½æ˜¯ä½¿ç”¨å®ƒçš„å®ç°ç±»ï¼ŒçœŸæ­£ç®¡ç†äº‹åŠ¡çš„å¯¹è±¡ï¼š</p>

      <ul>
        <li>org.springframework.jdbc.datasource.DataSourceTransactionManagerï¼šä½¿ç”¨ Spring JDBC æˆ–iBatis è¿›è¡ŒæŒä¹…åŒ–æ•°æ®æ—¶ä½¿ç”¨</li>
        <li>org.springframework.orm.hibernate5.HibernateTransactionManagerï¼šä½¿ç”¨Hibernate ç‰ˆæœ¬è¿›è¡ŒæŒä¹…åŒ–æ•°æ®æ—¶ä½¿ç”¨</li>
      </ul>
    </blockquote>
  </li>
  <li>
    <p><code class="highlighter-rouge">TransactionDefinition</code>:å®ƒæ˜¯äº‹åŠ¡çš„å®šä¹‰ä¿¡æ¯å¯¹è±¡</p>

    <ul>
      <li>
        <p>String getName()ï¼šè·å–äº‹åŠ¡å¯¹è±¡åç§°</p>
      </li>
      <li>
        <p>Int getIsolationLevel()ï¼šè·å–äº‹åŠ¡éš”ç¦»çº§åˆ«</p>
      </li>
      <li>
        <p>Int getPropagetionBehavior()ï¼šè·å–äº‹åŠ¡ä¼ æ’­è¡Œä¸º</p>
      </li>
      <li>
        <p>int getTimeout()ï¼šè·å–äº‹åŠ¡è¶…å‡ºæ—¶é—´</p>
      </li>
      <li>
        <p>Boolean isReadOnly()ï¼šè·å–äº‹åŠ¡æ˜¯å¦åªè¯»</p>

        <blockquote>
          <p>è¯»å†™å‹äº‹åŠ¡ï¼šå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹å¼€å¯äº‹åŠ¡ã€‚åªè¯»å‹äº‹åŠ¡ï¼šæ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¹Ÿä¼šå¼€å¯äº‹åŠ¡</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="highlighter-rouge">TransactionStatus</code>ï¼šæ­¤æ¥å£æä¾›çš„æ˜¯äº‹åŠ¡å…·ä½“è¿è¡ŒçŠ¶æ€</p>

    <ul>
      <li>void flush()ï¼šåˆ·æ–°äº‹åŠ¡</li>
      <li>boolean hasSavepoint()ï¼šè·å–æ˜¯å¦å­˜åœ¨å­˜å‚¨ç‚¹</li>
      <li>boolean isCompleted()ï¼šè·å–äº‹åŠ¡æ˜¯å¦å®Œæˆ</li>
      <li>boolean isNewTransaction()ï¼šè·å–äº‹åŠ¡æ˜¯å¦ä¸ºæ–°çš„äº‹åŠ¡</li>
      <li>boolean isRollbackOnly()ï¼šè·å–äº‹åŠ¡æ˜¯å¦ä¼šæ»š</li>
      <li>void setRollbackOnly()ï¼šè®¾ç½®äº‹åŠ¡å›æ»š</li>
    </ul>
  </li>
</ul>

<h4 id="14-äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º">1.4 äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</h4>

<ul>
  <li>
    <p><strong>äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºå°±æ˜¯å¤šä¸ªäº‹åŠ¡æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå¦‚ä½•å®šä¹‰æ–¹æ³•é—´äº‹åŠ¡çš„ä¼ æ’­</strong></p>
  </li>
  <li>
    <p><code class="highlighter-rouge">Propagation</code>æ”¯æŒ7ç§ä¸åŒçš„ä¼ æ’­æœºåˆ¶:</p>

    <ul>
      <li><strong>REQUIRED</strong>ï¼šä¸šåŠ¡æ–¹æ³•éœ€è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è¿è¡Œï¼Œå¦‚æœæ–¹æ³•è¿è¡Œæ—¶ï¼Œå·²å¤„äºä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œé‚£ä¹ˆä¹…åŠ å…¥åˆ°è¯¥äº‹åŠ¡ä¸­ï¼Œå¦åˆ™è‡ªå·±åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚<strong>è¿™æ˜¯Spring é»˜è®¤çš„ä¼ æ’­è¡Œä¸º</strong>ã€‚</li>
      <li><strong>SUPPORTS</strong>ï¼šå¦‚æœä¸šåŠ¡æ–¹æ³•åœ¨æŸä¸ªäº‹åŠ¡èŒƒå›´å†…è¢«è°ƒç”¨ï¼Œåˆ™æ–¹æ³•æˆä¸ºè¯¥äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æœä¸šåŠ¡æ–¹æ³•åœ¨äº‹åŠ¡èŒƒå›´å¤–è¢«å¾…ç”¨ï¼Œåˆ™æ–¹æ³•åœ¨æ²¡æœ‰äº‹åŠ¡çš„ç¯å¢ƒä¸‹æ‰§è¡Œã€‚</li>
      <li><strong>MANDATORY</strong>ï¼šåªèƒ½åœ¨ä¸€ä¸ªå·²å­˜åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä¸šåŠ¡æ–¹æ³•ä¸èƒ½å‘èµ·è‡ªå·±çš„äº‹åŠ¡ï¼Œå¦‚æœä¸šåŠ¡æ–¹æ³•åœ¨æ— äº‹åŠ¡çš„ç¯å¢ƒä¸‹è°ƒç”¨ï¼Œå°±æŠ›å¼‚å¸¸</li>
      <li><strong>REQUIRES_NEW</strong>ï¼šä¸šåŠ¡æ–¹æ³•æ€»æ˜¯ä¼šä¸ºè‡ªå·±å‘èµ·ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœæ–¹æ³•å·²è¿è¡Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œåˆ™åŸæ²¹äº‹åŠ¡è¢«æŒ‚èµ·ï¼Œæ–°çš„äº‹åŠ¡è¢«åˆ›å»ºï¼ŒçŸ¥é“æ–¹æ³•ç»“æŸï¼Œæ–°äº‹ç‰©æ‰ç»“æŸï¼ŒåŸå…ˆçš„äº‹åŠ¡æ‰ä¼šæ¢å¤æ‰§è¡Œã€‚</li>
      <li><strong>NOT_SUPPORTED</strong>ï¼šå£°æ˜æ–¹æ³•éœ€è¦äº‹åŠ¡ï¼Œå¦‚æœæ–¹æ³•æ²¡æœ‰å…³è”åˆ°ä¸€ä¸ªäº‹åŠ¡ï¼Œå®¹å™¨ä¸ä¼šä¸ºå®ƒå¼€å¯äº‹åŠ¡ã€‚å¦‚æœæ–¹æ³•åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è¢«è°ƒç”¨ï¼Œè¯¥äº‹åŠ¡ä¼šè¢«æŒ‚èµ·ï¼Œåœ¨æ–¹æ³•è°ƒç”¨ç»“æŸåï¼ŒåŸå…ˆçš„äº‹åŠ¡ä¾¿ä¼šæ¢å¤æ‰§è¡Œã€‚</li>
      <li><strong>NEVER</strong>ï¼šå£°æ˜æ–¹æ³•ç»å¯¹ä¸èƒ½åœ¨äº‹åŠ¡èŒƒå›´å†…æ‰§è¡Œï¼Œå¦‚æœæ”¾å•Šæ”¾åœ¨æŸä¸ªäº‹åŠ¡èŒƒå›´å†…æ‰§è¡Œï¼Œå®¹å™¨å°±æŠ›å¼‚å¸¸ã€‚åªæœ‰æ²¡å…³è”åˆ°äº‹åŠ¡ï¼Œæ‰æ­£å¸¸æ‰§è¡Œã€‚</li>
      <li><strong>NESTED</strong>ï¼šå¦‚æœä¸€ä¸ªæ´»åŠ¨çš„äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™è¿è¡Œåœ¨ä¸€ä¸ªåµŒå¥—çš„äº‹åŠ¡ä¸­ã€‚å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„äº‹åŠ¡ï¼Œåˆ™æŒ‰REQUIRED å±æ€§æ‰§è¡Œã€‚å®ƒä½¿ç”¨äº†ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ï¼Œè¿™ä¸ªäº‹åŠ¡æ‹¥æœ‰å¤šä¸ªå¯ä»¥ä¼šæ»šçš„ä¿è¯ç‚¹ã€‚å†…éƒ¨äº‹åŠ¡ä¼šæ»šä¸ä¼šå¯¹å¤–éƒ¨äº‹åŠ¡é€ æˆå½±å“ï¼Œå®ƒåªå¯¹ DateSourceTransactionManageräº‹åŠ¡ç®¡ç†å™¨èµ·æ•ˆã€‚</li>
    </ul>

    <blockquote>
      <p>ã€æ‰©å±•ã€‘REQUIRED_NEWå’ŒNESTEDä¸¤ç§ä¼ æ’­æœºåˆ¶çš„åŒºåˆ«ï¼Ÿ</p>

      <ul>
        <li>REQUIRED_NEWï¼šå†…éƒ¨çš„äº‹åŠ¡ç‹¬ç«‹è¿è¡Œï¼Œåœ¨å„è‡ªçš„ä½œç”¨åŸŸä¸­ï¼Œå¯ä»¥ç‹¬ç«‹çš„ä¼šæ»šæˆ–è€…æäº¤ï¼›è€Œå¤–éƒ¨çš„äº‹åŠ¡å°†ä¸å—å†…éƒ¨äº‹åŠ¡çš„ä¼šæ»šçŠ¶æ€çš„å½±å“ã€‚</li>
        <li>NESTEDï¼šåŸºäºå•ä¸€çš„äº‹åŠ¡æ¥ç®¡ç†ï¼Œæä¾›äº†ä¸œå“¥ä¿å­˜ç‚¹ã€‚è¿™ç§å¤šä¸ªä¿å­˜ç‚¹çš„æœºåˆ¶å…è®¸å†…éƒ¨äº‹åŠ¡çš„å˜æ›´è§¦å‘å¤–éƒ¨äº‹åŠ¡çš„å›æ»šã€‚è€Œå¤–éƒ¨äº‹åŠ¡åœ¨å›æ»šä¹‹åï¼Œä»èƒ½ç»§ç»­è¿›è¡Œäº‹åŠ¡å¤„ç†ï¼Œå³ä½¿éƒ¨åˆ†æ“ä½œå·²ç»è¢«ä¼šæ»šã€‚ç”±äºè¿™ä¸ªè®¾ç½®ç»™äºˆ JDBC çš„ä¿å­˜ç‚¹ï¼Œæ‰€ä»¥åªèƒ½åœ¨JDBCçš„æœºåˆ¶æ‰§è¡Œã€‚</li>
      </ul>

      <p>ç”±æ­¤å¯çŸ¥ï¼Œä¸¤è€…éƒ½æ˜¯äº‹åŠ¡åµŒå¥—ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œå†…éƒ¨äº‹åŠ¡ä¹‹é—´æ˜¯å¦å­˜åœ¨å½¼æ­¤ä¹‹é—´çš„å½±å“ï¼›NESTEDä¹‹é—´ä¼šå—åˆ°å½±å“ï¼Œè€Œäº§ç”Ÿéƒ¨åˆ†å›æ»šï¼Œè€ŒREQUIRED_NEWåˆ™æ˜¯ç‹¬ç«‹çš„ã€‚</p>
    </blockquote>
  </li>
</ul>

<h4 id="15-äº‹åŠ¡çš„éš”ç¦»çº§åˆ«">1.5 äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼š</h4>

<p>éš”ç¦»çº§åˆ«åæ˜ äº‹åŠ¡æäº¤å¹¶å‘è®¿é—®æ—¶çš„å¤„ç†æ€åº¦ï¼Œ<code class="highlighter-rouge">TransactionDefinition</code>æ¥å£ä¸­å®šä¹‰äº†äº”ä¸ªè¡¨ç¤ºéš”ç¦»çº§åˆ«çš„å¸¸é‡ï¼š</p>

<ul>
  <li>
    <p>ISOLATION_DEFAULTï¼šé»˜è®¤çº§åˆ«ï¼Œå½’å±ä¸‹åˆ—æŸä¸€ç§</p>
  </li>
  <li>
    <p>ISOLATION_READ_UNCOMMITTEDï¼šæ˜¯æœ€ä½çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒå…è®¸å¦ä¸€äº‹åŠ¡çœ‹åˆ°è¿™ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚</p>
  </li>
  <li>
    <p>ISOLATION_READ_COMMITTEDï¼šä¿è¯ä¸€ä¸ªäº‹åŠ¡æäº¤åæ‰èƒ½è¢«å¦ä¸€äº‹åŠ¡è¯»å–ã€‚å¦ä¸€äº‹åŠ¡ä¸èƒ½è¯»å–è¯¥äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚</p>
  </li>
  <li>
    <p>ISOLATION_REPEATABLE_READï¼šè¿™ç§äº‹åŠ¡éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ï¼Œä¸å¯é‡å¤è¯»ã€‚ä½†æ˜¯å¯èƒ½å‡ºç°å¹»æƒ³è¯»ã€‚å®ƒé™¤äº†ä¿è¯ä¸€ä¸ªäº‹åŠ¡ä¸èƒ½è¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»å–æœªæäº¤çš„æ•°æ®ä»¥å¤–è¿˜é¿å…äº†ä¸€ä¸‹æƒ…å†µçš„äº§ç”Ÿ(ä¸å¯é‡å¤è¯»)</p>
  </li>
  <li>
    <p>ISOLATION_SERIALIZABLEï¼šè¿™ä¸ªèŠ±è´¹æœ€é«˜ä»£ä»·ä½†æ˜¯æœ€å¯é çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚äº‹åŠ¡è¢«å¤„ç†æœªé¡ºåºæ‰§è¡Œã€‚é™¤äº†é˜²æ­¢è„è¯»ï¼Œä¸å¯é‡å¤è¯»ä¹‹å¤–ï¼Œè¿˜é¿å…äº†å¹»è±¡è¯»ã€‚</p>

    <blockquote>
      <p><code class="highlighter-rouge">è„è¯»</code>ï¼šæŒ‡å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®ï¼Œå¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§æ•°æ®è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚å› ä¸ºè¿™ä¸ªæ•°æ®è¿˜æ²¡æœ‰æäº¤é‚£ä¹ˆå¦ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°è¿™ä¸ªæ•°æ®æˆ‘ä»¬ç§°ä¸ºè„æ•°æ®ã€‚ä¾æ®è„æ•°æ®æ‰€åšçš„æ“ä½œè‚¯å®šæ˜¯ä¸æ­£ç¡®çš„ã€‚</p>

      <p><code class="highlighter-rouge">ä¸å¯é‡å¤è¯»</code>ï¼šåªåœ¨ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œå¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æ‰§è¡Œç»“æŸï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥åŒä¸€æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¿ç»­è¯»å–æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»ç‰©çš„æ•°æ®å¯èƒ½ä¸ä¸€æ ·çš„ï¼Œè¿™æ ·å°±å‘ç”Ÿäº†åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…çš„ä¸¤æ¬¡è¯»å–æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚</p>

      <p><code class="highlighter-rouge">å¹»è±¡è¯»</code>ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–ä¸€ä¸ªèŒƒå›´çš„è®°å½•ï¼Œä½†ä¸¤æ¬¡è¯»å–çš„è®°å½•æ•°ä¸åŒï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå¹»æƒ³è¯»(ä¸¤æ¬¡æ‰§è¡ŒåŒä¸€æ¡select è¯­å¥ä¼šå‡ºç°ä¸åŒçš„ç»“æœï¼Œç¬¬äºŒæ¬¡è¯»å–å›å¢åŠ ä¸€æ•°æ®è¡Œï¼Œå¹¶æ²¡æœ‰è¯´è¿™ä¸ªä¸¤æ¬¡æ‰§è¡Œæ˜¯åŒä¸€ä¸ªäº‹åŠ¡ä¸­)</p>
    </blockquote>
  </li>
</ul>

<h4 id="16-springäº‹åŠ¡å›æ»šè§„åˆ™">1.6 Springäº‹åŠ¡å›æ»šè§„åˆ™</h4>

<p>æŒ‡ç¤ºSpring äº‹åŠ¡ç®¡ç†å™¨å›æ»šä¸€ä¸ªäº‹åŠ¡çš„æ¨èæ–¹æ³•æ—¶åœ¨å½“å‰äº‹åŠ¡çš„ä¸Šä¸‹æ–‡å†…æŠ›å‡ºå¼‚å¸¸ã€‚Spring äº‹åŠ¡ç®¡ç†å™¨ä¼šæ•è·æœªå¤„ç†çš„å¼‚å¸¸ï¼Œç„¶åä¾æ®è§„åˆ™å†³å®šæ˜¯å¦å›æ»šæŠ›å‡ºå¼‚å¸¸çš„äº‹åŠ¡ã€‚</p>

<p>æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹å¼‚å¸¸çš„æ¶æ„</p>

<ul>
  <li>å¼‚å¸¸çš„ç»§æ‰¿ç»“æ„ï¼šErrorå’ŒRuntimeExceptionåŠå…¶å­ç±»æˆä¸ºæœªæ£€æŸ¥å¼‚å¸¸ï¼ˆuncheckedï¼‰ï¼Œå…¶å®ƒå¼‚å¸¸æˆä¸ºå·²æ£€æŸ¥å¼‚å¸¸ï¼ˆcheckedï¼‰ã€‚</li>
  <li><img src="/img/images/spring/05/01-spring-interface.png" alt="01-spring-interface" /></li>
  <li><img src="/img/images/spring/05/02-exception.png" alt="02-exception" /></li>
</ul>

<p>é»˜è®¤é…ç½®ä¸‹ï¼ŒSpring åªæœ‰åœ¨æŠ›å‡ºå¼‚å¸¸ä¸ºè¿è¡Œæ—¶uncheckedå¼‚å¸¸æ—¶æ‰å›æ»šè¯¥äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯æŠ›å‡ºå¼‚å¸¸ä¸ºRuntimeException çš„å­ç±»(Errorsä¹Ÿä¼šå¯¼è‡´äº‹åŠ¡å›æ»š)ï¼Œè€ŒæŠ›å‡ºcheckedå¼‚å¸¸åˆ™ä¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šã€‚å¯ä»¥æ˜ç¡®çš„é…ç½®åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶å›æ»šäº‹åŠ¡ï¼Œ<code class="highlighter-rouge">åŒ…æ‹¬checkedå¼‚å¸¸</code>ã€‚ä¹Ÿå¯ä»¥æ˜ç¡®å®šä¹‰é‚£äº›å¼‚å¸¸æŠ›å‡ºæ—¶ä¸å›æ»šäº‹åŠ¡ã€‚è¿˜å¯ä»¥ç¼–ç¨‹æ€§çš„é€šè¿‡setRollbackOnly() æ–¹æ³•æŒ‡ç¤ºä¸€ä¸ªäº‹åŠ¡å¿…é¡»å›æ»šï¼Œåœ¨è°ƒç”¨å®Œ setRollbackOnly()åä½ æ‰€èƒ½æ‰§è¡Œçš„å”¯ä¸€æ“ä½œå°±æ˜¯å›æ»šã€‚</p>

<h4 id="17-springäº‹åŠ¡å®ç°æ–¹å¼">1.7 <code class="highlighter-rouge">Springäº‹åŠ¡å®ç°æ–¹å¼</code></h4>

<ol>
  <li>ç¼–ç¨‹å¼ç®¡ç†å¯¹ç»™äºˆ POJO çš„åº”ç”¨æ¥è¯´æ˜¯å”¯ä¸€é€‰æ‹©ã€‚æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­è°ƒç”¨ beginTransaction()ã€commit()ã€rollback()ç­‰äº‹åŠ¡ç®¡ç†ç›¸å…³çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ã€‚</li>
  <li>åŸºäº TransactionProxyFactotyBean çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†</li>
  <li>åŸºäº @Transaction çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†</li>
  <li>åŸºäº Aspectj AOP é…ç½®äº‹åŠ¡</li>
</ol>

<p>ã€æ€»ç»“ã€‘</p>

<ul>
  <li><code class="highlighter-rouge">ç¼–ç¨‹å¼äº‹åŠ¡</code>ç®¡ç†ä½¿ç”¨ <strong>TransactionTemplate</strong> æˆ–è€…ç›´æ¥ä½¿ç”¨åº•å±‚çš„ <code class="highlighter-rouge">PlatformTransactionManager</code>ã€‚å¯¹ä¸ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼ŒSpring æ¨èä½¿ç”¨ <strong>TransactionTemplate</strong>ã€‚</li>
  <li><code class="highlighter-rouge">å£°æ˜å¼äº‹åŠ¡</code>ç®¡ç†å»ºç«‹åœ¨ <strong>AOP</strong> ä¹‹ä¸Šçš„ï¼Œå…¶æœ¬è´¨æ˜¯å¯¹æ–¹æ³•å‰åè¿›è¡Œæ‹¦æˆªï¼Œç„¶ååœ¨ç›®æ ‡æ–¹æ³•å¼€å§‹ä¹‹å‰åˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨æ‰§è¡Œå®Œç›®æ ‡æ–¹æ³•ä¹‹åæ ¹æ®æ‰§è¡Œæƒ…å†µæäº¤æˆ–è€…å›æ»šäº‹åŠ¡ã€‚å£°æ˜å¼äº‹åŠ¡æœ€å¤§ä¼˜ç‚¹æ˜¯ä¸éœ€è¦é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼ç®¡ç†äº‹åŠ¡ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­å‚æ‚äº‹åŠ¡ç®¡ç†çš„ä»£ç ï¼Œåªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­ä½œç›¸å…³çš„äº‹åŠ¡è§„åˆ™å£°æ˜(æˆ–é€šè¿‡ç»™äºˆ @Transactionæ³¨è§£çš„æ–¹å¼)ï¼Œä¾¿å¯ä»¥å°†äº‹åŠ¡è§„åˆ™åº”ç”¨åˆ°ä¸šåŠ¡é€»è¾‘ä¸­ã€‚</li>
  <li>æ˜¾ç„¶å£°æ˜å¼äº‹åŠ¡ç®¡ç†è¦ä¼˜äºç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼Œè¿™æ­£æ˜¯ Spring æå€¡çš„éä¾µå…¥å¼çš„å¼€å‘æ–¹å¼ã€‚å£°æ˜å¼äº‹åŠ¡ç®¡ç†ä½¿ä¸šåŠ¡ä»£ç ä¸å—æ±¡æŸ“ï¼Œä¸€ä¸ªæ™®é€šçš„ POJO å¯¹è±¡ï¼Œåªéœ€è¦åŠ ä¸Šæ³¨è§£å°±å¯ä»¥è·å–å®Œå…¨çš„äº‹åŠ¡æ”¯æŒã€‚å’Œç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ç›¸æ¯”ï¼Œå£°æ˜å¼äº‹åŠ¡å”¯ä¸€çš„ä¸è¶³åœ°æ–¹æ˜¯ï¼Œåè€…çš„æœ€ç»†ç²’åº¦åªèƒ½ä½œç”¨åˆ°æ–¹æ³•çº§åˆ«ï¼Œæ— æ³•åšåˆ°åƒç¼–ç¨‹å¼äº‹åŠ¡é‚£æ ·å¯ä»¥ä½œç”¨åˆ°ä»£ç å—çº§åˆ«ã€‚ä½†æ˜¯å³ä½¿æœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œä¹Ÿå­˜åœ¨å¾ˆå¤šå˜é€šçš„æ–¹æ³•ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥å°†éœ€è¦è¿›è¡Œäº‹åŠ¡ç®¡ç†çš„ä»£ç å—ç‹¬ç«‹ä¸ºæ–¹æ³•ç­‰ç­‰ã€‚</li>
</ul>

<h2 id="äºŒspringäº‹åŠ¡å®ç°å…·ä½“">äºŒã€<code class="highlighter-rouge">Springäº‹åŠ¡å®ç°å…·ä½“</code></h2>

<h4 id="21-ç¯å¢ƒæ­å»º">2.1 ç¯å¢ƒæ­å»º</h4>

<ol>
  <li>
    <p>æ‹·è´å¿…è¦çš„ jar åŒ…åˆ°å·¥ç¨‹çš„ lib ç›®å½•</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-aop<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.8.7<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åˆ›å»º spring çš„é…ç½®æ–‡ä»¶å¹¶å¯¼å…¥çº¦æŸ</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- éœ€è¦å¯¼å…¥ aop å’Œ tx ä¸¤ä¸ªåç§°ç©ºé—´ --&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
      <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
      <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
      <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                          http://www.springframework.org/schema/beans/spring -beans.xsd
                          http://www.springframework.org/schema/tx
                          http://www.springframework.org/schema/tx/spring-tx.xsd
                          http://www.springframework.org/schema/aop
                          http://www.springframework.org/schema/aop/spring -aop.xsd"</span><span class="nt">&gt;</span>
   
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>å‡†å¤‡æ•°æ®åº“è¡¨å’Œå®ä½“ç±»</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
   
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span> <span class="c1">// ä¸»é”®</span>
    <span class="err">â€¦â€¦</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ç¼–å†™ä¸šåŠ¡å±‚æ¥å£å’Œå®ç°ç±»</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductService</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">transfer</span><span class="o">();</span> <span class="c1">//å¢åˆ æ”¹ </span>
<span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"productService"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductServiceImpl</span> <span class="kd">implements</span> <span class="nc">ProductService</span> <span class="o">{</span>
   
    <span class="nd">@Autowired</span>
 <span class="kd">private</span> <span class="nc">ProductMapper</span> <span class="n">productMapper</span><span class="o">;</span>
   
    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"676C5BD1D35E429A8C2E114939C5685A"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"12B7ABF2A4C544568B0A7C69F36BF8B7"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ç¼–å†™æ•°æ®å±‚</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductMapper</span> <span class="o">{</span>
   
    <span class="nd">@Update</span><span class="o">(</span><span class="s">"update mall_product set product_price = product_price + '1000' where id = #{id}"</span><span class="o">)</span>
    <span class="nd">@Options</span><span class="o">(</span><span class="n">useGeneratedKeys</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">updateProductPrice</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- é…ç½® spring åˆ›å»ºå®¹å™¨æ—¶è¦æ‰«æçš„åŒ… --&gt;</span> <span class="c">&lt;!-- å¼€å¯æ³¨è§£æ‰«æï¼Œç®¡ç†serviceå’Œdao --&gt;</span>
   <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.silhouette.*.service"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.silhouette.*.mapper"</span><span class="nt">/&gt;</span>
      
   <span class="c">&lt;!-- æ•°æ®åº“è¿æ¥æ±  --&gt;</span>
   <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:jdbc.properties"</span> <span class="nt">/&gt;</span>
      
   <span class="c">&lt;!-- æ•°æ®æºå®šä¹‰,ä½¿ç”¨ druid è¿æ¥æ±  --&gt;</span>
   <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.alibaba.druid.pool.DruidDataSource"</span> <span class="na">destroy-method=</span><span class="s">"close"</span><span class="nt">&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"${jdbc.driver}"</span> <span class="nt">/&gt;</span>
      
       <span class="c">&lt;!-- ç”Ÿäº§ç¯å¢ƒè¯·æŠŠè¿æ¥å€¼æ”¹å¤§ä¸€ç‚¹ --&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"initialSize"</span> <span class="na">value=</span><span class="s">"${jdbc.initialSize}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minIdle"</span> <span class="na">value=</span><span class="s">"${jdbc.minIdle}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxIdle"</span> <span class="na">value=</span><span class="s">"${jdbc.maxIdle}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxActive"</span> <span class="na">value=</span><span class="s">"${jdbc.maxActive}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxWait"</span> <span class="na">value=</span><span class="s">"${jdbc.maxWait}"</span> <span class="nt">/&gt;</span>
      
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"validationQuery"</span> <span class="na">value=</span><span class="s">"${jdbc.validationQuery}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"logAbandoned"</span> <span class="na">value=</span><span class="s">"${jdbc.logAbandoned}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"removeAbandoned"</span> <span class="na">value=</span><span class="s">"${jdbc.removeAbandoned}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minEvictableIdleTimeMillis"</span> <span class="na">value=</span><span class="s">"${jdbc.minEvictableIdleTimeMillis}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"timeBetweenEvictionRunsMillis"</span> <span class="na">value=</span><span class="s">"${jdbc.timeBetweenEvictionRunsMillis}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"testOnBorrow"</span> <span class="na">value=</span><span class="s">"${jdbc.testOnBorrow}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"testOnReturn"</span> <span class="na">value=</span><span class="s">"${jdbc.testOnReturn}"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"testWhileIdle"</span> <span class="na">value=</span><span class="s">"${jdbc.testWhileIdle}"</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;/bean&gt;</span>
      
   <span class="c">&lt;!-- é…ç½®mybatis --&gt;</span>
   <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sqlSessionFactory"</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.SqlSessionFactoryBean"</span><span class="nt">&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:SqlMapConfig.xml"</span><span class="nt">/&gt;</span>
       <span class="c">&lt;!--mapper.xmlæ‰€åœ¨ä½ç½®--&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"mapperLocations"</span> <span class="na">value=</span><span class="s">"classpath:mapper/**/*Mapper.xml"</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;/bean&gt;</span>
      
   <span class="c">&lt;!-- æ‰«ædaoæ¥å£ --&gt;</span>
   <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"mapperScanner"</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span class="nt">&gt;</span>
       <span class="c">&lt;!--mapperæ¥å£æ‰€åœ¨çš„åŒ…--&gt;</span>
       <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"basePackage"</span> <span class="na">value=</span><span class="s">"com.silhouette.*.mapper"</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/bean&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="22-åŸºäº-transactionproxyfactorybeançš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†">2.2 <code class="highlighter-rouge">åŸºäº TransactionProxyFactoryBeançš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†</code></h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- é…ç½®ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨ --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myTracnsactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span> <span class="nt">&gt;</span>
  	<span class="c">&lt;!-- æ³¨å…¥ DataSource --&gt;</span>
	  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- äº‹åŠ¡ä»£ç†å·¥å‚ --&gt;</span>
<span class="c">&lt;!-- ç”Ÿæˆäº‹åŠ¡ä»£ç†å¯¹è±¡ --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"serviceProxy"</span> <span class="na">class=</span><span class="s">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionManager"</span> <span class="na">ref=</span><span class="s">"myTracnsactionManager"</span><span class="nt">/&gt;</span>
  	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionAttributes"</span><span class="nt">&gt;</span>
      	<span class="nt">&lt;props&gt;</span>
          	<span class="c">&lt;!-- ä¸»è¦ key æ˜¯æ–¹æ³•
										ISOLATION_DEFAULT  äº‹åŠ¡çš„éš”ç¦»çº§åˆ«
										PROPAGATION_REQUIRED  ä¼ æ’­è¡Œä¸º
						--&gt;</span>
          	<span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"add*"</span><span class="nt">&gt;</span>ISOLATION_DEFAULT,PROPAGATION_REQUIRED<span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"update*"</span><span class="nt">&gt;</span>ISOLATION_DEFAULT,PROPAGATION_REQUIRED<span class="nt">&lt;/prop&gt;</span>
						<span class="c">&lt;!-- -Exception è¡¨ç¤ºå‘ç”ŸæŒ‡å®šå¼‚å¸¸å›æ»šï¼Œ+Exception è¡¨ç¤ºå‘ç”ŸæŒ‡å®šå¼‚å¸¸æäº¤ --&gt;</span>
						<span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"transfer"</span><span class="nt">&gt;</span>ISOLATION_DEFAULT,PROPAGATION_REQUIRED,RuntimeException<span class="nt">&lt;/prop&gt;</span>
	      <span class="nt">&lt;/props&gt;</span>
	  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<h4 id="23-åŸºäº-transactional-çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†">2.3 <code class="highlighter-rouge">åŸºäº @Transactional çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†</code></h4>

<ol>
  <li>
    <p>é…ç½®äº‹åŠ¡</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
     
<span class="c">&lt;!-- å¼€å¯ spring å¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ --&gt;</span>
<span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">/&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>@Transactionæ³¨è§£å±æ€§è¯´æ˜</p>

    <table>
      <thead>
        <tr>
          <th>å±æ€§</th>
          <th>ç±»å‹</th>
          <th>æè¿°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>value</td>
          <td>String</td>
          <td>å¯é€‰çš„é™å®šæè¿°ç¬¦ï¼ŒæŒ‡å®šä½¿ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨</td>
        </tr>
        <tr>
          <td>propagation</td>
          <td>enumï¼šPropagation</td>
          <td>å¯é€‰çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºè®¾ç½®</td>
        </tr>
        <tr>
          <td>isolation</td>
          <td>enumï¼šIsolation</td>
          <td>å¯é€‰çš„äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®</td>
        </tr>
        <tr>
          <td>readOnly</td>
          <td>boolean</td>
          <td>è¯»å†™æˆ–è€…åªè¯»äº‹åŠ¡ï¼Œé»˜è®¤è¯»å†™</td>
        </tr>
        <tr>
          <td>timeout</td>
          <td>Intï¼ˆin seconds granularity)</td>
          <td>äº‹åŠ¡è‰é£Ÿæ—¶é—´è®¾ç½®</td>
        </tr>
        <tr>
          <td>rollbackFor</td>
          <td>Classå¯¹è±¡æ•°ç»„ï¼Œå¿…é¡»ç»§æ‰¿è‡ªThrowable</td>
          <td>å¯¼è‡´äº‹åŠ¡å›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„</td>
        </tr>
        <tr>
          <td>rollbackForClassName</td>
          <td>ç±»åæ•°ç»„ï¼Œå¿…é¡»ç»§æ‰¿è‡ªThrowable</td>
          <td>å¯¼è‡´äº‹åŠ¡ä¼šæ»šçš„å¼‚å¸¸ç±»åå­—æ•°ç»„</td>
        </tr>
        <tr>
          <td>noRollbackFor</td>
          <td>Classå¯¹è±¡æ•°ç»„ï¼Œå¿…é¡»ç»§æ‰¿è‡ªThrowable</td>
          <td>ä¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„</td>
        </tr>
        <tr>
          <td>noRollbackForClassName</td>
          <td>ç±»åæ•°ç»„ï¼Œå¿…é¡»ç»§æ‰¿è‡ªThrowable</td>
          <td>ä¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šçš„å¼‚å¸¸ç±»åå­—æ•°ç»„</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>åœ¨ä¸šåŠ¡å±‚ä½¿ç”¨ @Transactional æ³¨è§£</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span><span class="o">(</span><span class="s">"accountService"</span><span class="o">)</span>
<span class="cm">/**
 * è¯¥æ³¨è§£çš„å±æ€§å’Œ xml ä¸­çš„å±æ€§å«ä¹‰ä¸€è‡´ã€‚è¯¥æ³¨è§£å¯ä»¥å‡ºç°åœ¨æ¥å£ä¸Šï¼Œç±»ä¸Šå’Œæ–¹æ³•ä¸Šã€‚ã€ä¼˜å…ˆçº§ï¼šæ–¹æ³• &gt; ç±» &gt; æ¥å£ã€‘
 * 	å‡ºç°æ¥å£ä¸Šï¼Œè¡¨ç¤ºè¯¥æ¥å£çš„æ‰€æœ‰å®ç°ç±»éƒ½æœ‰äº‹åŠ¡æ”¯æŒã€‚
 *   å‡ºç°åœ¨ç±»ä¸Šï¼Œè¡¨ç¤ºç±»ä¸­æ‰€æœ‰æ–¹æ³•æœ‰äº‹åŠ¡æ”¯æŒ
 *   å‡ºç°åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºæ–¹æ³•æœ‰äº‹åŠ¡æ”¯æŒã€‚
 *       æ³¨è§£åªèƒ½åº”ç”¨åˆ°publicæ–¹æ³•ä¸Šï¼Œä½œç”¨äºprotectedã€privateæ—¶ï¼Œä¼šè¢«å¿½ç•¥ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œè¿™æ˜¯æœ‰Spring AOPçš„æœ¬è´¨å†³å®šçš„ã€‚
 */</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span><span class="n">propagation</span><span class="o">=</span><span class="nc">Propagation</span><span class="o">.</span><span class="na">SUPPORTS</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountServiceImpl</span> <span class="kd">implements</span> <span class="nc">IAccountService</span> <span class="o">{</span>
  	<span class="nd">@Autowired</span>
	  <span class="kd">private</span> <span class="nc">IAccountDao</span> <span class="n">accountDao</span><span class="o">;</span>
     	
  	<span class="nd">@Override</span>
     <span class="nd">@Transactional</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
       	<span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"676C5BD1D35E429A8C2E114939C5685A"</span><span class="o">);</span>
         <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="mi">0</span><span class="o">;</span>
         <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"12B7ABF2A4C544568B0A7C69F36BF8B7"</span><span class="o">);</span>
     <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æµ‹è¯•ä¸€ä¸‹</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="c1">//ä½¿ç”¨junit4è¿›è¡Œæµ‹è¯•</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="o">{</span><span class="s">"classpath:applicationContext-spring.xml"</span><span class="o">,</span> <span class="s">"classpath:SqlMapConfig.xml"</span><span class="o">})</span> 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoTest</span> <span class="o">{</span>
   
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ProductService</span> <span class="n">productService</span><span class="o">;</span>
   
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTransaction1</span><span class="o">(){</span>
        <span class="n">productService</span><span class="o">.</span><span class="na">transfer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>ã€æ‰©å±•1ã€‘</p>

<ul>
  <li>
    <p>å¦‚æœåœ¨ç¨‹åºä¸­è‡ªå·±æ•è·äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆäº‹åŠ¡å°±ä¸ä¼šå›æ»š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">//@Transactional(noRollbackFor= {ArithmeticException.class,RuntimeException.class})</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
    <span class="cm">/*productMapper.updateProductPrice("676C5BD1D35E429A8C2E114939C5685A");
          int i = 1 /0;
          productMapper.updateProductPrice("12B7ABF2A4C544568B0A7C69F36BF8B7");*/</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"676C5BD1D35E429A8C2E114939C5685A"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"12B7ABF2A4C544568B0A7C69F36BF8B7"</span><span class="o">);</span><span class="c1">//å‰é¢çš„æ“ä½œä¼šå›æ»š</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
      	<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åŸå› åˆ†æï¼š</p>

    <ul>
      <li>
        <p>åœ¨springçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ•°æ®æºçš„defaultAutoCommitè®¾ç½®ä¸ºTrueäº†ï¼Œé‚£ä¹ˆæ–¹æ³•ä¸­å¦‚æœè‡ªå·±<strong>æ•è·äº†å¼‚å¸¸</strong>ï¼Œ<strong>äº‹åŠ¡</strong>æ˜¯<strong>ä¸ä¼šå›æ»š</strong>çš„ï¼Œå¦‚æœ<strong>æ²¡æœ‰è‡ªå·±æ•è·å¼‚å¸¸åˆ™äº‹åŠ¡ä¼šå›æ»š</strong>ã€‚</p>

        <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- å¼€å¯ spring å¯¹æ³¨è§£äº‹åŠ¡çš„æ”¯æŒ --&gt;</span>
<span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span> <span class="na">proxy-target-class=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>å¯èƒ½ä½ ä¼šå‘ç°ä½ å¹¶æ²¡æœ‰é…ç½®è¿™ä¸ªå‚æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹æˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®åº“è¿æ¥æ± ï¼Œè¿™é‡Œä»¥ Druidè¿æ¥æ± ä¸ºä¾‹ã€‚</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æŸ¥çœ‹æºç å¯çŸ¥
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DruidAbstractDataSource</span> <span class="kd">extends</span> <span class="nc">WrapperAdapter</span> <span class="kd">implements</span> <span class="nc">DruidAbstractDataSourceMBean</span><span class="o">,</span> <span class="nc">DataSource</span><span class="o">,</span> <span class="nc">DataSourceProxy</span><span class="o">,</span> <span class="nc">Serializable</span> <span class="o">{</span>
  	<span class="err">â€¦â€¦</span>
    <span class="kd">protected</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">defaultAutoCommit</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>  
    <span class="err">â€¦â€¦</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>è§£å†³æ–¹æ³•ï¼Œæ‰‹åŠ¨å›æ»šäº‹åŠ¡</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">//@Transactional(noRollbackFor= {ArithmeticException.class,RuntimeException.class})</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
    <span class="cm">/*productMapper.updateProductPrice("676C5BD1D35E429A8C2E114939C5685A");
          int i = 1 /0;
          productMapper.updateProductPrice("12B7ABF2A4C544568B0A7C69F36BF8B7");*/</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"676C5BD1D35E429A8C2E114939C5685A"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"12B7ABF2A4C544568B0A7C69F36BF8B7"</span><span class="o">);</span><span class="c1">//å‰é¢çš„æ“ä½œä¼šå›æ»š</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="nc">TransactionAspectSupport</span><span class="o">.</span><span class="na">currentTransactionStatus</span><span class="o">().</span><span class="na">setRollbackOnly</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>æ¨èï¼šå¯¹äºè¦è¿›è¡Œäº‹åŠ¡çš„æ–¹æ³•ï¼Œä¸ä½¿ç”¨ try catchï¼Œåœ¨ä¸Šå±‚è°ƒç”¨æ—¶å¤„ç†å¼‚å¸¸ã€‚å¦‚æœä¸Šå±‚è°ƒç”¨æ—¶ä¸æƒ³å¤„ç†å¼‚å¸¸ï¼Œåˆ™å¯ä»¥åœ¨catchå—ä¸­å¢åŠ <code class="highlighter-rouge">TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</code>è¯­å¥è¿›è¡Œæ‰‹åŠ¨å›æ»šã€‚</p>
</blockquote>

<p>ã€æ‰©å±•2ã€‘</p>

<ul>
  <li>
    <p>Springå£°æ˜å¼äº‹åŠ¡é»˜è®¤ä¼šå¯¹éæ£€æŸ¥å‹å¼‚å¸¸å’Œè¿è¡Œæ—¶å¼‚å¸¸è¿›è¡Œå›æ»šï¼Œè€Œå¯¹æ£€æŸ¥å‹å¼‚å¸¸ä¸è¿›è¡Œå›æ»šæ“ä½œã€‚<code class="highlighter-rouge">å¯¹é»˜è®¤è§„åˆ™è¿›è¡Œä¿®æ”¹</code></p>

    <ol>
      <li>
        <p>è®©checkedå¼‚å¸¸ä¹Ÿè¿›è¡Œå›æ»š</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>è®©uncheckedå¼‚å¸¸ä¹Ÿä¸å›æ»š</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">noRollbackFor</span><span class="o">=</span> <span class="nc">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>ä¸éœ€è¦äº‹åŠ¡</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span><span class="o">=</span><span class="nc">Propagation</span><span class="o">.</span><span class="na">NOT_SUPPORTED</span><span class="o">)</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>å¦‚æœä¸æ·»åŠ rollbackForç­‰å±æ€§ï¼ŒSpringç¢°åˆ°Unchecked Exceptionséƒ½ä¼šå›æ»šï¼Œä¸ä»…æ˜¯RuntimeExceptionï¼Œä¹ŸåŒ…æ‹¬Errorã€‚</p>
      </li>
    </ol>
  </li>
</ul>

<p>ã€æ‰©å±•3ã€‘</p>

<ul>
  <li>
    <p>ä¸ä½¿ç”¨ xml çš„é…ç½®æ–¹å¼é…ç½®ã€å…¨æ³¨è§£ã€‘</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * å’Œè¿æ¥æ•°æ®åº“ç›¸å…³çš„é…ç½®ç±»
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcConfig</span> <span class="o">{</span>
  
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${jdbc.driver}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">driver</span><span class="o">;</span>
  
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${jdbc.url}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">url</span><span class="o">;</span>
  
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${jdbc.username}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
  
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${jdbc.password}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
  
    <span class="cm">/**
     * åˆ›å»ºJdbcTemplate
     * @param dataSource
     * @return
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"jdbcTemplate"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JdbcTemplate</span> <span class="nf">createJdbcTemplate</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="cm">/**
     * åˆ›å»ºæ•°æ®æºå¯¹è±¡
     * @return
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"dataSource"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">createDataSource</span><span class="o">(){</span>
        <span class="nc">DriverManagerDataSource</span> <span class="n">ds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">();</span>
        <span class="n">ds</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
        <span class="n">ds</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">ds</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">ds</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionConfig</span> <span class="o">{</span>
    <span class="cm">/**
     * ç”¨äºåˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨å¯¹è±¡
     * @param dataSource
     * @return
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"transactionManager"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">createTransactionManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * springçš„é…ç½®ç±»ï¼Œç›¸å½“äºbean.xml
 */</span>
<span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">"com.silhouette"</span><span class="o">)</span>
<span class="nd">@Import</span><span class="o">({</span><span class="nc">JdbcConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">TransactionConfig</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="nd">@PropertySource</span><span class="o">(</span><span class="s">"jdbc.properties"</span><span class="o">)</span>
<span class="nd">@EnableTransactionManagement</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="24-åŸºäº-aspectj-aop-é…ç½®äº‹åŠ¡">2.4 <code class="highlighter-rouge">åŸºäº Aspectj AOP é…ç½®äº‹åŠ¡</code></h4>

<ol>
  <li>
    <p>äº‹åŠ¡é…ç½®</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
   
<span class="c">&lt;!-- äº‹åŠ¡çš„é…ç½® --&gt;</span>
<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tx:attributes&gt;</span>
        <span class="c">&lt;!-- æŒ‡å®šæ–¹æ³•åç§°ï¼šæŒ‡çš„æ˜¯ä¸šåŠ¡æ ¸å¿ƒæ–¹æ³•
             read-onlyï¼šæ˜¯å¦æ˜¯åªè¯»äº‹åŠ¡ã€‚é»˜è®¤ falseï¼Œä¸åªè¯»ã€‚
             isolationï¼šæŒ‡å®šäº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚é»˜è®¤å€¼æ˜¯ä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚
             propagationï¼šæŒ‡å®šäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€‚
             timeoutï¼šæŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚é»˜è®¤å€¼ä¸ºï¼š-1ã€‚æ°¸ä¸è¶…æ—¶ã€‚
             rollback-forï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå¼‚å¸¸ï¼Œå½“æ‰§è¡Œäº§ç”Ÿè¯¥å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡å›æ»šã€‚äº§ç”Ÿå…¶ä»–å¼‚å¸¸ï¼Œäº‹åŠ¡ä¸å›æ»šã€‚æ²¡æœ‰é»˜è®¤å€¼ï¼Œä»»ä½•å¼‚å¸¸éƒ½å›æ»šã€‚
             no-rollback-for ï¼šç”¨äºæŒ‡å®šä¸€ä¸ªå¼‚å¸¸ï¼Œå½“äº§ç”Ÿè¯¥å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡ä¸å›æ»šï¼Œ äº§ç”Ÿå…¶ä»–å¼‚å¸¸æ—¶ï¼Œ äº‹åŠ¡å›æ»šã€‚æ²¡æœ‰é»˜è®¤å€¼ï¼Œä»»ä½•å¼‚å¸¸éƒ½å›æ»šã€‚
        --&gt;</span>
        <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"transfer"</span> <span class="na">isolation=</span><span class="s">"DEFAULT"</span> <span class="na">propagation=</span><span class="s">"REQUIRED"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--&lt;tx:method name="transfer" isolation="DEFAULT" propagation="REQUIRED" 
													rollback-for="com.silhouette.framework.exception.BaseTxException"/&gt;--&gt;</span>
    <span class="nt">&lt;/tx:attributes&gt;</span>
<span class="nt">&lt;/tx:advice&gt;</span>
   
<span class="c">&lt;!-- é…ç½® aop --&gt;</span>
<span class="nt">&lt;aop:config&gt;</span>
		<span class="c">&lt;!-- é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ --&gt;</span>
		<span class="nt">&lt;aop:pointcut</span> <span class="na">expression=</span><span class="s">"execution(* com.silhouette.service.impl.*.*(..))"</span> <span class="na">id=</span><span class="s">"pt1"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"pt1"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æµ‹è¯•</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>  <span class="c1">//ä½¿ç”¨junit4è¿›è¡Œæµ‹è¯•</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="o">{</span><span class="s">"classpath:applicationContext-spring.xml"</span><span class="o">,</span> <span class="s">"classpath:SqlMapConfig.xml"</span><span class="o">})</span> 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoTest</span> <span class="o">{</span>
   
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ProductService</span> <span class="n">productService</span><span class="o">;</span>
   
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTransaction1</span><span class="o">(){</span>
        <span class="cm">/*
         * æ³¨æ„ï¼šè¯¥æ–¹æ³•å·²äº¤ç”±Springè¿›è¡Œäº‹åŠ¡ç®¡ç†
         *    &lt;tx:method name="transfer" isolation="DEFAULT" propagation="REQUIRED"/&gt;
         * æˆ–è€…ç»Ÿä¸€ä¸€æ ·å¤„ç†
         * &lt;tx:method name="*" isolation="DEFAULT" propagation="REQUIRED" 
         * 										rollback-for="com.silhouette.framework.exception.BaseAppException"/&gt;
         */</span>
        <span class="n">productService</span><span class="o">.</span><span class="na">transfer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ã€æ‰©å±•ã€‘ç¨‹åºä¸­è‡ªå·±æ•è·äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆäº‹åŠ¡å°±ä¸ä¼šå›æ»š</p>

    <ul>
      <li>
        <p>ç¤ºä¾‹ä»£ç ï¼š</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"676C5BD1D35E429A8C2E114939C5685A"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"12B7ABF2A4C544568B0A7C69F36BF8B7"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>åŸå› åˆ†æï¼š</p>

        <ul>
          <li>Springçš„AOPå³å£°æ˜å¼äº‹åŠ¡ç®¡ç†é»˜è®¤æ˜¯é’ˆå¯¹ unchecked exceptionå›æ»šã€‚ä¹Ÿå°±æ˜¯é»˜è®¤å¯¹RuntimeException()å¼‚å¸¸æˆ–æ˜¯å…¶å­ç±»è¿›è¡Œäº‹åŠ¡å›æ»šï¼›checkedå¼‚å¸¸,å³Exceptionå¯try{}æ•è·çš„ä¸ä¼šå›æ»šï¼Œ</li>
          <li>å¦‚æœä½¿ç”¨try-catchæ•è·æŠ›å‡ºçš„uncheckedå¼‚å¸¸åæ²¡æœ‰åœ¨catchå—ä¸­é‡‡ç”¨é¡µé¢ç¡¬ç¼–ç çš„æ–¹å¼ä½¿ç”¨spring apiå¯¹äº‹åŠ¡åšæ˜¾å¼çš„å›æ»šï¼Œåˆ™äº‹åŠ¡ä¸ä¼šå›æ»šã€‚</li>
        </ul>
      </li>
      <li>
        <p>è§£å†³æ–¹æ³• â€“ åœ¨é’ˆå¯¹äº‹åŠ¡çš„ç±»ä¸­æŠ›å‡ºRuntimeExceptionå¼‚å¸¸ï¼Œè€Œä¸æ˜¯æŠ›å‡ºExceptionã€‚</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"676C5BD1D35E429A8C2E114939C5685A"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">productMapper</span><span class="o">.</span><span class="na">updateProductPrice</span><span class="o">(</span><span class="s">"12B7ABF2A4C544568B0A7C69F36BF8B7"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h4 id="25-äº‹åŠ¡å›æ»šæ€»ç»“">2.5 äº‹åŠ¡å›æ»šæ€»ç»“</h4>

<ul>
  <li>
    <p>äº‹åŠ¡éƒ¨å›æ»šåŸå› åˆ†æ</p>

    <ul>
      <li>å› ä¸ºç¼–ç¨‹å¼äº‹åŠ¡éƒ½æ˜¯æ‰‹åŠ¨å›æ»šçš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°äº‹åŠ¡ä¸å›æ»šçš„æƒ…å†µï¼Œå³ä¸å›æ»šéƒ½æ˜¯å‡ºç°åœ¨å£°æ˜å¼äº‹åŠ¡ä¸­çš„ã€‚</li>
      <li>å£°æ˜å¼äº‹åŠ¡å›æ»šçš„åŸç†æ˜¯ï¼š<code class="highlighter-rouge">å½“è¢«åˆ‡é¢åˆ‡ä¸­æˆ–è€…æ˜¯åŠ äº†æ³¨è§£çš„æ–¹æ³•ä¸­æŠ›å‡ºäº†RuntimeExceptionå¼‚å¸¸æ—¶ï¼ŒSpringä¼šè¿›è¡Œäº‹åŠ¡å›æ»šã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯æ•è·åˆ°æ–¹æ³•çš„RuntimeExceptionå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æŠ›å‡ºåªè¦å±äºè¿è¡Œæ—¶çš„å¼‚å¸¸ï¼ˆå³RuntimeExceptionåŠå…¶å­ç±»ï¼‰éƒ½èƒ½å›æ»šï¼›ä½†å½“æŠ›å‡ºä¸€ä¸ªä¸å±äºè¿è¡Œæ—¶å¼‚å¸¸æ—¶ï¼Œäº‹åŠ¡æ˜¯ä¸ä¼šå›æ»šçš„ã€‚</code></li>
      <li>å¸¸è§ä¸å›æ»šçš„åœºæ™¯ï¼š
        <ul>
          <li>å£°æ˜å¼äº‹åŠ¡é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å†™é”™äº†ï¼Œæ²¡åˆ‡ä¸­Serviceä¸­çš„æ–¹æ³•</li>
          <li>Serviceæ–¹æ³•ä¸­ï¼ŒæŠŠå¼‚å¸¸ç»™try catchäº†ï¼Œä½†catché‡Œé¢åªæ˜¯æ‰“å°äº†å¼‚å¸¸ä¿¡æ¯ï¼Œæ²¡æœ‰æ‰‹åŠ¨æŠ›å‡ºRuntimeExceptionå¼‚å¸¸</li>
          <li>Serviceæ–¹æ³•ä¸­ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸ä¸å±äºè¿è¡Œæ—¶å¼‚å¸¸ï¼ˆå¦‚IOå¼‚å¸¸ï¼‰ï¼Œå› ä¸ºSpringé»˜è®¤æƒ…å†µä¸‹æ˜¯æ•è·åˆ°è¿è¡Œæ—¶å¼‚å¸¸å°±å›æ»š</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>ä¿è¯äº‹åŠ¡å›æ»šçš„æ–¹å¼</p>

    <ol>
      <li>
        <p>å£°æ˜å¼äº‹åŠ¡é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å†™é”™äº†ï¼Œæ²¡åˆ‡ä¸­Serviceä¸­çš„æ–¹æ³•</p>
      </li>
      <li>
        <p>å¦‚æœServiceå±‚ä¼šæŠ›å‡ºä¸å±äºè¿è¡Œæ—¶å¼‚å¸¸ä¹Ÿè¦èƒ½å›æ»šï¼Œé‚£ä¹ˆå¯ä»¥å°†Springé»˜è®¤çš„å›æ»šæ—¶çš„å¼‚å¸¸ä¿®æ”¹ä¸ºExceptionï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯ç¢°åˆ°ä»€ä¹ˆå¼‚å¸¸éƒ½å¯ä»¥å›æ»šã€‚å…·ä½“çš„è®¾ç½®æ–¹å¼ä¹Ÿè¯´ä¸‹ï¼š</p>

        <ul>
          <li>
            <p>å£°æ˜å¼äº‹åŠ¡ï¼Œåœ¨é…ç½®é‡Œé¢æ·»åŠ ä¸€ä¸ªrollback-forï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

            <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"update*"</span> <span class="na">propagation=</span><span class="s">"REQUIRED"</span> <span class="na">rollback-for=</span><span class="s">"java.lang.Exception"</span><span class="nt">/&gt;</span> 
</code></pre></div>            </div>
          </li>
          <li>
            <p>æ³¨è§£äº‹åŠ¡ï¼Œç›´æ¥åœ¨æ³¨è§£ä¸Šé¢æŒ‡å®šï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

            <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span><span class="o">=</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>
        <p>åªæœ‰éåªè¯»äº‹åŠ¡æ‰èƒ½å›æ»šçš„ï¼Œåªè¯»äº‹åŠ¡æ˜¯ä¸ä¼šå›æ»šçš„ã€‚</p>
      </li>
      <li>
        <p>å¦‚æœåœ¨Serviceå±‚ç”¨äº†try catchï¼Œåœ¨catché‡Œé¢å†æŠ›å‡ºä¸€ä¸ª RuntimeExceptionå¼‚å¸¸ï¼Œè¿™æ ·å‡ºäº†å¼‚å¸¸æ‰ä¼šå›æ»š</p>
      </li>
      <li>
        <p>å¯ä»¥åœ¨å°†æ–¹å¼4 ä¸­çš„æŠ›å‡ºå¼‚å¸¸æ”¹ä¸ºï¼Œåœ¨catchå—ä¸­æ·»åŠ æ‰‹åŠ¨å›æ»šçš„è¯­å¥<code class="highlighter-rouge">TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</code></p>

        <blockquote>
          <p>æ³¨æ„ï¼šè¯¥æ–¹å¼çš„å‰ææ˜¯å¿…é¡»å¼€å¯æ³¨è§£å¼äº‹åŠ¡çš„æ”¯æŒ</p>
        </blockquote>
      </li>
    </ol>
  </li>
</ul>

<blockquote>
  <p><em>å¦‚æœ‰ä»»ä½•çŸ¥è¯†äº§æƒã€ç‰ˆæƒé—®é¢˜æˆ–ç†è®ºé”™è¯¯ï¼Œè¿˜è¯·æŒ‡æ­£ã€‚</em></p>
</blockquote>

:ET