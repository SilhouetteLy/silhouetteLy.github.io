I"Ü-<h2 id="å‰è¨€">å‰è¨€</h2>

<ul>
  <li><a href="https://www.cnblogs.com/qlqwjy/p/9763754.html">rediså®ç°æ¶ˆæ¯é˜Ÿåˆ—&amp;å‘å¸ƒ/è®¢é˜…æ¨¡å¼ä½¿ç”¨</a></li>
</ul>

<h2 id="ä¸€redis-å®ç°æ¶ˆæ¯é˜Ÿåˆ—">ä¸€ã€Redis å®ç°æ¶ˆæ¯é˜Ÿåˆ—</h2>

<h3 id="11-redis-åˆ—è¡¨ç±»å‹å›é¡¾">1.1 Redis åˆ—è¡¨ç±»å‹å›é¡¾</h3>

<p>åˆ—è¡¨ç±»å‹ï¼ˆlistï¼‰å¯ä»¥å­˜å‚¨ä¸€ä¸ªæœ‰åºçš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå¸¸ç”¨çš„æ“ä½œæ˜¯å‘åˆ—è¡¨ä¸¤ç«¯æ·»åŠ å…ƒç´ ï¼Œæˆ–è€…è·å¾—åˆ—è¡¨çš„æŸä¸ªç‰‡æ®µã€‚åˆ—è¡¨ç±»å‹å†…éƒ¨æ˜¯ä½¿ç”¨<code class="highlighter-rouge">åŒå‘é“¾è¡¨(double linked list)</code>å®ç°çš„ã€‚å¯ä»¥ç”¨æ¥ç”¨æ¥å®ç°é˜Ÿåˆ—ï¼Œå¹¶ä¸”æ”¯æŒé˜»å¡å¼è¯»å–ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ä¼˜å…ˆé˜Ÿåˆ—ã€‚listæ“ä½œå›é¡¾<a href="">ä¼ é€é—¨</a>ã€‚</p>

<h3 id="12-java-ç¨‹åºå®ç°æ¶ˆæ¯é˜Ÿåˆ—">1.2 Java ç¨‹åºå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3>

<ul>
  <li>
    <p>redis.properties</p>

    <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">redis.url</span><span class="p">=</span><span class="s">192.168.30.200</span>
<span class="py">redis.port</span><span class="p">=</span><span class="s">6379</span>
<span class="py">redis.maxIdle</span><span class="p">=</span><span class="s">30</span>
<span class="py">redis.minIdle</span><span class="p">=</span><span class="s">10</span>
<span class="py">redis.maxTotal</span><span class="p">=</span><span class="s">100</span>
<span class="py">redis.maxWait</span><span class="p">=</span><span class="s">10000</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ä½¿ç”¨è¿æ¥æ± è®¿é—®redis</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JedisPoolUtils</span> <span class="o">{</span>
  
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">JedisPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  
    <span class="kd">static</span> <span class="o">{</span>
  
        <span class="c1">//åŠ è½½é…ç½®æ–‡ä»¶</span>
        <span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"redis.properties"</span><span class="o">);</span>
        <span class="nc">Properties</span> <span class="n">pro</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">pro</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
  
        <span class="c1">//è·å¾—æ± å­å¯¹è±¡</span>
        <span class="nc">JedisPoolConfig</span> <span class="n">poolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisPoolConfig</span><span class="o">();</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">pro</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"redis.maxIdle"</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span><span class="c1">//æœ€å¤§é—²ç½®ä¸ªæ•°</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">pro</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"redis.maxWait"</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span><span class="c1">//æœ€å¤§é—²ç½®ä¸ªæ•°</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">pro</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"redis.minIdle"</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span><span class="c1">//æœ€å°é—²ç½®ä¸ªæ•°</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">pro</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"redis.maxTotal"</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span><span class="c1">//æœ€å¤§è¿æ¥æ•°</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisPool</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">pro</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"redis.url"</span><span class="o">),</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">pro</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"redis.port"</span><span class="o">).</span><span class="na">toString</span><span class="o">()));</span>
    <span class="o">}</span>
  
    <span class="c1">//è·å¾—jedisèµ„æºçš„æ–¹æ³•</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Jedis</span> <span class="nf">getJedis</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">pool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">getJedis</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ¶ˆæ¯ç”Ÿäº§è€…(å¼€å¯å¤šçº¿ç¨‹ç”Ÿäº§æ¶ˆæ¯)</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageProducer</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MESSAGE_KEY</span> <span class="o">=</span> <span class="s">"message:queue"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">getJedis</span><span class="o">();</span>
      	<span class="c1">//jedis.select(1);</span>
        <span class="nc">Long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">lpush</span><span class="o">(</span><span class="no">MESSAGE_KEY</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
                           <span class="s">" put message,size="</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="s">",count="</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
        <span class="n">count</span><span class="o">++;</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">putMessage</span><span class="o">(</span><span class="s">"message"</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProducer</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageProducer</span><span class="o">,</span> <span class="s">"thread1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageProducer</span><span class="o">,</span> <span class="s">"thread2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageProducer</span><span class="o">,</span> <span class="s">"thread3"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>è¿è¡Œç»“æœ</p>

        <p><img src="/img/images/redis/02/01-redisç”Ÿäº§æ¶ˆæ¯.png" /></p>

        <blockquote>
          <p>Tipsï¼šç”±ä¸Šå›¾å¯çŸ¥ï¼Œredis æ˜¯å•çº¿ç¨‹æ“ä½œçš„ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªçš„æ“ä½œã€‚</p>
        </blockquote>
      </li>
      <li>
        <p>redis åå°æŸ¥çœ‹</p>

        <p><img src="/img/images/redis/02/02-rediså®¢æˆ·ç«¯æŸ¥çœ‹ç”Ÿäº§çš„æ¶ˆæ¯.png" /></p>

        <blockquote>
          <p>Tipsï¼šä½¿ç”¨<code class="highlighter-rouge">lrange</code>å‘½ä»¤æŸ¥çœ‹æ•°æ®æ—¶å¯çŸ¥ï¼Œ<code class="highlighter-rouge">lpush</code>å‘½ä»¤æ’å…¥æ•°æ®æ˜¯ä»å·¦å‘å³æ“ä½œçš„ã€‚</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>
    <p>æ¶ˆæ¯æ¶ˆè´¹è€…(å¼€å¯å¤šçº¿ç¨‹æ¶ˆæ¯æ¶ˆæ¯)</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageConsumer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MESSAGE_KEY</span> <span class="o">=</span> <span class="s">"message:queue"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumerMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">getJedis</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">rpop</span><span class="o">(</span><span class="no">MESSAGE_KEY</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" consumer message,message="</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">",count="</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
        <span class="n">count</span><span class="o">++;</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">consumerMessage</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageConsumer</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageConsumer</span><span class="o">,</span> <span class="s">"thread1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageConsumer</span><span class="o">,</span> <span class="s">"thread2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageConsumer</span><span class="o">,</span> <span class="s">"thread3"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>è¿è¡Œç»“æœ</p>

        <p><img src="/img/images/redis/02/03-redisæ¶ˆè´¹æ¶ˆæ¯.png" /></p>
      </li>
      <li>
        <p><code class="highlighter-rouge">è¿è¡Œç»“æœåˆ†æ</code></p>

        <ul>
          <li>
            <p>æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æ—¶éœ€è¦<code class="highlighter-rouge">ä¸åœ</code>çš„è°ƒç”¨ rpop æ–¹æ³•æŸ¥çœ‹ List é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯ã€‚è€Œä¸”æ¶ˆæ¯æ¶ˆè´¹å®Œäº†ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šä¸åœçš„è°ƒç”¨ rpopæ–¹æ³•ï¼Œä»è€Œé€ æˆå¤šä½™çš„è¿æ¥æµªè´¹ã€‚</p>

            <p><img src="/img/images/redis/02/04-redisæ¶ˆè´¹æ¶ˆæ¯.png" /></p>
          </li>
          <li>
            <p>ä¹Ÿè®¸ä½ ä¼šä½¿ç”¨<code class="highlighter-rouge">Thread.sleepï¼ˆï¼‰</code>ç­‰æ–¹æ³•è®©æ¶ˆè´¹è€…çº¿ç¨‹éš”ä¸€æ®µæ—¶é—´å†æ¶ˆè´¹ï¼Œä½†æ˜¯è¿™æ ·åšä¹Ÿä¼šå‡ºç°å¦‚ä¸‹é—®é¢˜ï¼š</p>

            <ul>
              <li>å½“ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦å¤§é›¨æ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦æ—¶ï¼Œä¼šé€ æˆæ¶ˆæ¯é˜Ÿåˆ—è¶Šæ¥è¶Šå¤§ï¼Œæ—¶é—´ä¹…äº†å°±ä¼šå ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´</li>
              <li>å½“ä¼‘çœ çš„æ—¶é—´è¿‡ç¨‹å°±æ— æ³•å®æ—¶æ¶ˆè´¹æ¶ˆæ¯ï¼›ä¼‘çœ æ—¶é—´è¿‡çŸ­ï¼Œæ¶ˆè´¹ä¸åˆ°æ¶ˆæ¯ï¼Œé€ æˆè¿æ¥èµ„æºçš„æµªè´¹ã€‚</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="13-brpopå’Œblpopå®ç°é˜»å¡è¯»å–">1.3 <code class="highlighter-rouge">brpop</code>å’Œ<code class="highlighter-rouge">blpop</code>å®ç°é˜»å¡è¯»å–</h3>

<p>ä¸ºè§£å†³ä¸Šè¿°ä¸€ç›´è°ƒç”¨ rpop æˆ– lpop å‘½ä»¤é€ æˆçš„è¿æ¥æµªè´¹ã€‚redis æä¾›äº†é˜»å¡å¼å‘½ä»¤ brpop å’Œ blpop å‘½ä»¤ã€‚brpop å‘½ä»¤å¯ä»¥æ¥æ”¶å¤šä¸ªé”®ï¼Œå…¶è¯­æ³•ï¼š<code class="highlighter-rouge">BRPOP key [key ...] timeout</code>ã€‚è¯¥å‘½ä»¤æ£€æµ‹å¤šä¸ªé”®ï¼Œå¦‚æœæ‰€æœ‰é”®éƒ½æ²¡æœ‰å…ƒç´ åˆ™é˜»å¡ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæœ‰å…ƒç´ åˆ™ä»è¯¥é”®ä¸­å¼¹å‡ºè¯¥å…ƒç´ ã€‚</p>

<ul>
  <li>
    <p>ç¤ºä¾‹1</p>

    <p><img src="/img/images/redis/02/05-brpopå‘½ä»¤.png" /></p>

    <blockquote>
      <p>Tipsï¼šä¼šæŒ‰ç…§ key çš„é¡ºåºè¿›è¡Œè¯»å–ï¼Œå¯ä»¥å®ç°å…·æœ‰ä¼˜å…ˆçº§çš„é˜Ÿåˆ—ã€‚å½“é˜Ÿåˆ—ä¸­æ— æ¶ˆæ¯æ—¶ä¼šè¿›è¡Œé˜»å¡ã€‚</p>
    </blockquote>
  </li>
  <li>
    <p>æµ‹è¯•2ï¼š</p>

    <ol>
      <li>
        <p>å¾€é˜»å¡çš„é˜Ÿåˆ—ä¸­æ·»åŠ æ¶ˆæ¯</p>

        <p><img src="/img/images/redis/02/06-æ·»åŠ æ¶ˆæ¯.png" /></p>
      </li>
      <li>
        <p>æŸ¥çœ‹ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯çš„é˜»å¡æ˜¯å¦æ”¾è¡Œ</p>

        <p><img src="/img/images/redis/02/07-é˜»å¡æ”¾è¡Œ.png" /></p>
      </li>
    </ol>
  </li>
  <li>
    <p>ä½¿ç”¨ brpop æˆ– blpop å‘½ä»¤ä¼˜åŒ–ä¸Šè¿°ä»£ç </p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewConsumer</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">{</span>
  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MESSAGE_KEY</span> <span class="o">=</span> <span class="s">"message:queue"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">getJedis</span><span class="o">();</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumerMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//0æ˜¯timeout,è¿”å›çš„æ˜¯ä¸€ä¸ªé›†åˆï¼Œç¬¬ä¸€ä¸ªæ˜¯æ¶ˆæ¯çš„keyï¼Œç¬¬äºŒä¸ªæ˜¯æ¶ˆæ¯çš„å†…å®¹</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">brpop</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="no">MESSAGE_KEY</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"brpop result="</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">consumerMessage</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      	<span class="c1">//new NewConsumer().consumerMessage();</span>
        <span class="nc">NewConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NewConsumer</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="s">"thread1"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>å…ˆæ¸…ç©ºæ•°æ®åº“ï¼Œå…ˆå¯åŠ¨æ¶ˆè´¹è€…ï¼Œå› ä¸ºæ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œæ§åˆ¶å°å°±æ²¡æœ‰ä»»ä½•çš„è¾“å‡º</p>
      </li>
      <li>
        <p>å½“å¯åŠ¨ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯åï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ¶ˆè´¹å®Œæ¯•åä¼šé˜»å¡åœæ»åœ¨è¿™é‡Œï¼ŒçŸ¥ç›´åˆ°æœ‰æ–°çš„æ¶ˆæ¯äº§ç”Ÿã€‚</p>

        <p><img src="/img/images/redis/02/08-ä¼˜åŒ–æ¶ˆè´¹æ¶ˆæ¯.png" /></p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="äºŒè®¢é˜…ä¸å‘å¸ƒæ¨¡å¼">äºŒã€è®¢é˜…ä¸å‘å¸ƒæ¨¡å¼</h2>

<h3 id="21-è®¢é˜…ä¸å‘å¸ƒ">2.1 è®¢é˜…ä¸å‘å¸ƒ</h3>

<p>Redis é€šè¿‡<code class="highlighter-rouge">PUBLISH</code>ã€<code class="highlighter-rouge">SUBSCRIBE</code>ç­‰å‘½ä»¤å®ç°äº†è®¢é˜…ä¸å‘å¸ƒæ¨¡å¼ï¼Œè¿™ä¸ªåŠŸèƒ½æä¾›ä¸¤ç§ä¿¡æ¯æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯è®¢é˜…/å‘å¸ƒåˆ°é¢‘é“å’Œè®¢é˜…/å‘å¸ƒåˆ°æ¨¡å¼ã€‚â€œå‘å¸ƒ/è®¢é˜…â€åŒ…å«äº†ä¸¤ç§è§’è‰²ï¼Œåˆ†åˆ«æ˜¯æ¶ˆæ¯çš„å‘å¸ƒè€…å’Œæ¶ˆæ¯çš„è®¢é˜…è€…ã€‚è®¢é˜…è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“(channel)ï¼Œè€Œå‘å¸ƒè€…å¯ä»¥å‘æŒ‡å®šçš„é¢‘é“(channel)å‘é€æ¶ˆæ¯ï¼Œæ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°æ­¤æ¶ˆæ¯ã€‚</p>

<h3 id="22-è®¢é˜…å‘å¸ƒåˆ°é¢‘é“">2.2 è®¢é˜…/å‘å¸ƒåˆ°é¢‘é“</h3>

<ul>
  <li>
    <p>è®¢é˜…é¢‘é“</p>

    <ul>
      <li>
        <p>Redis çš„<code class="highlighter-rouge">SUBSCRIBE</code>å‘½ä»¤å¯ä»¥è®©å®¢æˆ·ç«¯è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œæ¯å½“æœ‰æ–°ä¿¡æ¯å‘é€åˆ°è¢«è®¢é˜…çš„é¢‘é“æ—¶ï¼Œä¿¡æ¯å°±ä¼šè¢«å‘é€ç»™æ‰€æœ‰è®¢é˜…æŒ‡å®šé¢‘é“çš„å®¢æˆ·ç«¯ã€‚é¢‘é“ä¸å®¢æˆ·ç«¯å…³ç³»è§ä¸‹å›¾ï¼š</p>

        <p><img src="/img/images/redis/02/09-è®¢é˜…é¢‘é“.png" /></p>
      </li>
      <li>
        <p>è®¢é˜…é¢‘é“ä½¿ç”¨subscribe å‘½ä»¤ï¼Œè¯­æ³•ï¼š<code class="highlighter-rouge">subscribe channel1 [channel2 ...]</code></p>
      </li>
      <li>
        <p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; subscribe channel:1
Reading messages... <span class="o">(</span>press Ctrl-C to quit<span class="o">)</span>
1<span class="o">)</span> <span class="s2">"subscribe"</span>
2<span class="o">)</span> <span class="s2">"channel:1"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 1
</code></pre></div>        </div>

        <blockquote>
          <p>Tipsï¼šæ‰§è¡Œä¸Šè¿°å‘½ä»¤åå®¢æˆ·ç«¯å°±è¿›å…¥äº†è®¢é˜…çŠ¶æ€ï¼Œå¤„äºæ­¤çŠ¶æ€çš„å®¢æˆ·ç«¯ä¸èƒ½ä½¿ç”¨å¤„<code class="highlighter-rouge">subscribe</code>ã€<code class="highlighter-rouge">unsubscribe</code>ã€<code class="highlighter-rouge">psubscribe</code>å’Œ<code class="highlighter-rouge">punsubscribe</code>è¿™å››ä¸ªå±äºâ€œå‘å¸ƒ/è®¢é˜…â€ä¹‹å¤–çš„å‘½ä»¤å¦åˆ™ä¼šæŠ¥é”™</p>
        </blockquote>
      </li>
      <li>
        <p>æ¶ˆæ¯ç±»å‹çš„å–å€¼ï¼š</p>

        <ul>
          <li>
            <p><code class="highlighter-rouge">subscribe</code>ï¼šè¡¨ç¤ºè®¢é˜…æˆåŠŸåçš„åé¦ˆï¼Œç¬¬äºŒä¸ªå€¼æ˜¯è®¢é˜…çš„é¢‘é“åç§°ï¼Œç¬¬ä¸‰ä¸ªå€¼æ—¶å½“å‰å®¢æˆ·ç«¯è®¢é˜…çš„é¢‘é“æ•°é‡ã€‚</p>

            <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; subscribe channel:1
Reading messages... <span class="o">(</span>press Ctrl-C to quit<span class="o">)</span>
1<span class="o">)</span> <span class="s2">"subscribe"</span>
2<span class="o">)</span> <span class="s2">"channel:1"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 1
</code></pre></div>            </div>
          </li>
          <li>
            <p><code class="highlighter-rouge">message</code>ï¼šè¡¨ç¤ºæ¥å—åˆ°æ¶ˆæ¯çš„åé¦ˆï¼Œç¬¬äºŒä¸ªå€¼è¡¨ç¤ºè®¢é˜…çš„é¢‘é“åç§°ï¼Œç¬¬ä¸‰ä¸ªå€¼è¡¨ç¤ºæ¥å—çš„æ¶ˆæ¯çš„å…·ä½“å†…å®¹</p>

            <ul>
              <li>
                <p>å‘é€æ¶ˆæ¯</p>

                <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; publish channel:1 <span class="s1">'hi,silhouette!'</span>
<span class="o">(</span>integer<span class="o">)</span> 1
</code></pre></div>                </div>
              </li>
              <li>
                <p>æ¥å—æ¶ˆæ¯</p>

                <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1<span class="o">)</span> <span class="s2">"message"</span>
2<span class="o">)</span> <span class="s2">"channel:1"</span>
3<span class="o">)</span> <span class="s2">"hi,silhouette!"</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>
            <p><code class="highlighter-rouge">unsubscribe</code>ï¼šè¡¨ç¤ºå–æ¶ˆè®¢é˜…çš„åé¦ˆï¼Œç¬¬äºŒä¸ªå€¼è¡¨ç¤ºå–æ¶ˆè®¢é˜…çš„é¢‘é“åç§°ï¼Œç¬¬ä¸‰ä¸ªå€¼è¡¨ç¤ºå½“å‰å®¢æˆ·ç«¯è®¢é˜…çš„é¢‘é“æ•°ï¼Œå½“æ­¤å€¼ä¸º0æ—¶ä¼šé€€å‡ºè®¢é˜…çŠ¶æ€ã€‚</p>

            <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; unsubscribe channel:1
1<span class="o">)</span> <span class="s2">"unsubscribe"</span>
2<span class="o">)</span> <span class="s2">"channel:1"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 0
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>å‘å¸ƒä¿¡æ¯</p>

    <ul>
      <li>
        <p>å½“æœ‰æ–°çš„ä¿¡æ¯é€šè¿‡<code class="highlighter-rouge">PUBLISH</code>å‘½ä»¤å‘é€ç»™é¢‘é“ channel1 æ—¶ï¼Œè¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼š</p>

        <p><img src="/img/images/redis/02/10-å‘å¸ƒæ¶ˆæ¯.png" /></p>
      </li>
      <li>
        <p>å‘å¸ƒæ¶ˆæ¯ä½¿ç”¨ publishå‘½ä»¤ï¼Œè¯­æ³•ï¼š<code class="highlighter-rouge">publish channel message</code></p>
      </li>
      <li>
        <p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; publish channel1:1 hi
<span class="o">(</span>integer<span class="o">)</span> 0
</code></pre></div>        </div>

        <blockquote>
          <p>Tipsï¼šè¿”å›å€¼è¡¨ç¤ºæ¥å—è¿™æ¡æ¶ˆæ¯çš„è®¢é˜…è€…æ•°é‡ã€‚å‘å‡ºå»çš„æ¶ˆæ¯ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´å®¢æˆ·ç«¯è®¢é˜… channel1 ååªèƒ½æ¥å—åˆ°åç»­å‘å¸ƒåˆ°è¯¥é¢‘é“çš„æ¶ˆæ¯ï¼Œä¹‹å‰çš„å°±æ¥å—ä¸åˆ°äº†ã€‚</p>
        </blockquote>
      </li>
    </ul>
  </li>
</ul>

<h3 id="23-è®¢é˜…å‘å¸ƒåˆ°æ¨¡å¼">2.3 è®¢é˜…/å‘å¸ƒåˆ°æ¨¡å¼</h3>

<p>å½“æˆ‘ä»¬ä½¿ç”¨<code class="highlighter-rouge">PUBLISH</code>å‘½ä»¤å‘é€ä¿¡æ¯åˆ°æŸä¸ªé¢‘é“æ—¶ï¼Œä¸ä»…æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œå¦‚æœæœ‰æŸä¸ª/æŸäº›æ¨¡å¼å’Œè¿™ä¸ªé¢‘é“åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰è®¢é˜…è¿™ä¸ªã€‚è¿™äº›é¢‘é“çš„å®¢æˆ·ç«¯ä¹ŸåŒæ ·ä¼šæ”¶åˆ°ä¿¡æ¯ã€‚æ³¨æ„æ­¤æ—¶ä½¿ç”¨<code class="highlighter-rouge">psubscribe</code>å‘½ä»¤è¿›è¡Œè®¢é˜…é¢‘é“ï¼Œæ­¤å‘½ä»¤æ”¯æŒé€šé…ç¬¦æ ¼å¼ï¼Œè¯­æ³•ï¼š<code class="highlighter-rouge">psubscribe pattern [pattern ...]</code>ã€‚</p>

<blockquote>
  <p>Tipsï¼š<strong>é€šé…ç¬¦ä¸­<code class="highlighter-rouge">?</code>è¡¨ç¤ºä¸€ä¸ªå ä½ç¬¦ï¼Œ<code class="highlighter-rouge">*</code>è¡¨ç¤ºä»»æ„ä¸ªå ä½ç¬¦(åŒ…æ‹¬0)ï¼Œ<code class="highlighter-rouge">?*</code>è¡¨ç¤º1ä¸€ä¸ªä»¥ä¸Šçš„å ä½ç¬¦</strong></p>
</blockquote>

<p>ä¸‹å›¾å±•ç¤ºè¯¾ä¸€ä¸ªå¸¦é¢‘å¸¦å’Œæ¨¡å¼çš„ä¾‹å­ï¼Œå…¶ä¸­ tweet.shop.* æ¨¡å¼åŒ¹é…äº† tweet.shop.kindle é¢‘é“å’Œ tweet.shop.ipad é¢‘é“ï¼Œå¹¶ä¸”æœ‰ä¸åŒçš„å®¢æˆ·ç«¯åˆ†åˆ«è®¢é˜…ä»–ä»¬ä¸‰ä¸ªï¼š</p>

<p><img src="/img/images/redis/02/11-è®¢é˜…æ¨¡å¼.png" /></p>

<ul>
  <li>
    <p>å½“æœ‰ä¿¡æ¯å‘é€åˆ° tweet.shop.kindle é¢‘é“æ—¶ï¼Œä¿¡æ¯é™¤äº†å‘é€ç»™ cllientX å’Œ clientY ä¹‹å¤–ï¼Œè¿˜ä¼šå‘é€ç»™è®¢é˜…tweet.shop.* æ¨¡å¼çš„ client123 å’Œ client256ï¼š</p>

    <p><img src="/img/images/redis/02/12-æ¨¡å¼åŒ¹é…1.png" /></p>
  </li>
  <li>
    <p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ¥å—åˆ°ä¿¡æ¯çš„æ˜¯é¢‘é“tweet.shop.ipadï¼Œé‚£ä¹ˆ client123 å’Œ client256åŒæ ·ä¼šæ¥å—åˆ°ä¿¡æ¯ï¼š</p>

    <p><img src="/img/images/redis/02/13-æ¨¡å¼åŒ¹é…2.png" /></p>
  </li>
  <li>
    <p>å®ä¾‹æ¼”ç¤º</p>

    <ul>
      <li>
        <p>è®¢é˜…ä¸‰ä¸ªé¢‘é“</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; psubscribe tweet.shop.ipad tweet.shop.<span class="k">*</span> tweet.shop.kindle
Reading messages... <span class="o">(</span>press Ctrl-C to quit<span class="o">)</span>
1<span class="o">)</span> <span class="s2">"psubscribe"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.ipad"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 1
1<span class="o">)</span> <span class="s2">"psubscribe"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.*"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 2
1<span class="o">)</span> <span class="s2">"psubscribe"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.kindle"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 3
</code></pre></div>        </div>
      </li>
      <li>
        <p>å‘ tweet.shop.kindle é¢‘é“å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯</p>

        <ul>
          <li>
            <p>å‘é€æ¶ˆæ¯</p>

            <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; publish tweet.shop.kindle hi
<span class="o">(</span>integer<span class="o">)</span> 2
</code></pre></div>            </div>
          </li>
          <li>
            <p>æ¥å—æ¶ˆæ¯</p>

            <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1<span class="o">)</span> <span class="s2">"pmessage"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.*"</span> 			<span class="c"># ç›‘å¬ç®¡é“å</span>
3<span class="o">)</span> <span class="s2">"tweet.shop.kindle"</span>  <span class="c"># å®é™…ç®¡é“å</span>
4<span class="o">)</span> <span class="s2">"hi"</span>
1<span class="o">)</span> <span class="s2">"pmessage"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.kindle"</span>
3<span class="o">)</span> <span class="s2">"tweet.shop.kindle"</span>
4<span class="o">)</span> <span class="s2">"hi"</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>
        <p>å‘ tweet.shop.ipad é¢‘é“å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯</p>

        <ul>
          <li>
            <p>å‘é€æ¶ˆæ¯</p>

            <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; publish tweet.shop.ipad hello
<span class="o">(</span>integer<span class="o">)</span> 2  <span class="c">#è¿”å›å€¼è¡¨ç¤ºæ¥å—æ¶ˆæ¯çš„å®¢æˆ·ç«¯æ•°</span>
</code></pre></div>            </div>
          </li>
          <li>
            <p>æ¥å—æ¶ˆæ¯</p>

            <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1<span class="o">)</span> <span class="s2">"pmessage"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.ipad"</span>
3<span class="o">)</span> <span class="s2">"tweet.shop.ipad"</span>
4<span class="o">)</span> <span class="s2">"hello"</span>
1<span class="o">)</span> <span class="s2">"pmessage"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.*"</span>
3<span class="o">)</span> <span class="s2">"tweet.shop.ipad"</span>
4<span class="o">)</span> <span class="s2">"hello"</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>
        <p>å–æ¶ˆè®¢é˜…</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è¯­æ³•: punsubscribe [pattern [pattern ...]],å¦‚æœæ²¡æœ‰å‚æ•°åˆ™ä¼šé€€è®¢æ‰€æœ‰è§„åˆ™ã€‚</span>
127.0.0.1:6379&gt; punsubscribe tweet.shop.<span class="k">*</span> 
1<span class="o">)</span> <span class="s2">"punsubscribe"</span>
2<span class="o">)</span> <span class="s2">"tweet.shop.*"</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> 0
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="24-java-å®ç°å‘å¸ƒè€…è®¢é˜…è€…æ¨¡å¼">2.4 Java å®ç°å‘å¸ƒè€…è®¢é˜…è€…æ¨¡å¼</h3>

<ul>
  <li>
    <p>è®¢é˜…/å‘å¸ƒåˆ°é¢‘é“</p>

    <ul>
      <li>
        <p>ç¼–å†™æ¶ˆæ¯ç”Ÿäº§è€…</p>

        <ul>
          <li>
            <p>ä»£ç ç¤ºä¾‹</p>

            <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageProducer</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CHANNEL_KEY</span> <span class="o">=</span> <span class="s">"mychannel"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
      
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">getJedis</span><span class="o">();</span>
        <span class="nc">Long</span> <span class="n">publish</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="no">CHANNEL_KEY</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span><span class="c1">//è¿”å›è®¢é˜…è€…æ•°é‡</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" put message,count="</span> 
                           <span class="o">+</span> <span class="n">count</span><span class="o">+</span><span class="s">",subscriberNum="</span><span class="o">+</span><span class="n">publish</span><span class="o">);</span>
        <span class="n">count</span><span class="o">++;</span>
    <span class="o">}</span>
      
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">putMessage</span><span class="o">(</span><span class="s">"message"</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
      
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageProducer</span> <span class="n">producter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProducer</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">producter</span><span class="o">,</span> <span class="s">"thread1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">producter</span><span class="o">,</span> <span class="s">"thread2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">producter</span><span class="o">,</span> <span class="s">"thread3"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>            </div>
          </li>
          <li>
            <p>è¿è¡Œç»“æœ</p>

            <p><img src="/img/images/redis/02/14-ç”Ÿäº§æ¶ˆæ¯.png" /></p>
          </li>
        </ul>
      </li>
      <li>
        <p>ç¼–å†™<code class="highlighter-rouge">subscribe</code>è®¢é˜…è€…</p>

        <ul>
          <li>
            <p>ä»£ç ç¤ºä¾‹</p>

            <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageClient</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
      
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CHANNEL_KEY</span> <span class="o">=</span> <span class="s">"mychannel"</span><span class="o">;</span><span class="c1">//é¢‘é“</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EXIT_COMMAND</span> <span class="o">=</span> <span class="s">"exit"</span><span class="o">;</span><span class="c1">//ç»“æŸç¨‹åºçš„æ¶ˆæ¯</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUIT_COMMAND</span> <span class="o">=</span> <span class="s">"unsubscribe"</span><span class="o">;</span><span class="c1">//å–æ¶ˆè®¢é˜…</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumerMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">getJedis</span><span class="o">();</span>
        <span class="c1">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¤„ç†æ¥æ”¶æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è®¢é˜…çš„æ¶ˆæ¯é¢‘é“</span>
        <span class="n">jedis</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyJedisPubSub</span><span class="o">(),</span> <span class="no">CHANNEL_KEY</span><span class="o">);</span>
    <span class="o">}</span>
      
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">consumerMessage</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
      
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageClient</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageClient</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">messageConsumer</span><span class="o">,</span> <span class="s">"thread1"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
      
<span class="cm">/**
 * ç»§æ‰¿JedisPubSubï¼Œé‡å†™æ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³•
 */</span>
<span class="kd">class</span> <span class="nc">MyJedisPubSub</span> <span class="kd">extends</span> <span class="nc">JedisPubSub</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="cm">/** JedisPubSubç±»æ˜¯ä¸€ä¸ªæ²¡æœ‰æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»,é‡Œé¢æ–¹æ³•éƒ½æ˜¯ä¸€äº›ç©ºå®ç°
     * æ‰€ä»¥å¯ä»¥é€‰æ‹©éœ€è¦çš„æ–¹æ³•è¦†ç›–,è¿™å„¿ä½¿ç”¨çš„æ˜¯SUBSCRIBEæŒ‡ä»¤ï¼Œæ‰€ä»¥è¦†ç›–äº†onMessage
     * å¦‚æœä½¿ç”¨PSUBSCRIBEæŒ‡ä»¤ï¼Œåˆ™è¦†ç›–onPMessageæ–¹æ³•
     * å½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©BinaryJedisPubSub,åŒæ ·æ˜¯æŠ½è±¡ç±»ï¼Œä½†æ–¹æ³•å‚æ•°ä¸ºbyte[]
     **/</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"-æ¥æ”¶åˆ°æ¶ˆæ¯:channel="</span> <span class="o">+</span> 
                           <span class="n">channel</span> <span class="o">+</span> <span class="s">",message="</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="c1">//æ¥æ”¶åˆ°exitæ¶ˆæ¯åé€€å‡º</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">MessageClient</span><span class="o">.</span><span class="na">EXIT_COMMAND</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">MessageClient</span><span class="o">.</span><span class="na">QUIT_COMMAND</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">message</span><span class="o">)){</span>
            <span class="n">unsubscribe</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
        	
  	<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsubscribe</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ‰§è¡Œå–æ¶ˆè®¢é˜…æ“ä½œ"</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">(</span><span class="n">channels</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>
        <p>æµ‹è¯•ï¼šå…ˆå¯åŠ¨æ¶ˆè´¹è€…ï¼Œå†å¯åŠ¨ç”Ÿäº§è€…ï¼ŒæŸ¥çœ‹ä¸¤è€…æ§åˆ¶å°çš„è¾“å‡º</p>

        <p><img src="/img/images/redis/02/15-è®¢é˜…é¢‘é“.png" /></p>
      </li>
    </ul>
  </li>
  <li>
    <p>è®¢é˜…/å‘å¸ƒåˆ°æ¨¡å¼</p>

    <ul>
      <li>
        <p>ç¼–å†™<code class="highlighter-rouge">psubscribe</code>è®¢é˜…è€…</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageNewClient</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CHANNEL_KEY</span> <span class="o">=</span> <span class="s">"channel*"</span><span class="o">;</span><span class="c1">//é¢‘é“</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EXIT_COMMAND</span> <span class="o">=</span> <span class="s">"exit"</span><span class="o">;</span><span class="c1">//ç»“æŸç¨‹åºçš„æ¶ˆæ¯</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumerMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="nc">JedisPoolUtils</span><span class="o">.</span><span class="na">getJedis</span><span class="o">();</span>
        <span class="n">jedis</span><span class="o">.</span><span class="na">psubscribe</span><span class="o">(</span><span class="k">new</span> <span class="nc">MineJedisPubSub</span><span class="o">(),</span> <span class="no">CHANNEL_KEY</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">consumerMessage</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageNewClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageNewClient</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">client</span><span class="o">,</span><span class="s">"thread1"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
    
<span class="o">}</span>
<span class="cm">/**
 * ç»§æ‰¿JedisPubSubï¼Œé‡å†™æ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³•
 */</span>
<span class="kd">class</span> <span class="nc">MineJedisPubSub</span> <span class="kd">extends</span> <span class="nc">JedisPubSub</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">pattern</span><span class="o">,</span> <span class="nc">String</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"-æ¥æ”¶åˆ°æ¶ˆæ¯:pattern="</span><span class="o">+</span><span class="n">pattern</span><span class="o">+</span><span class="s">",channel="</span> 
                           <span class="o">+</span> <span class="n">channel</span> <span class="o">+</span> <span class="s">",message="</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="c1">//æ¥æ”¶åˆ°exitæ¶ˆæ¯åé€€å‡º</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">MessageNewClient</span><span class="o">.</span><span class="na">EXIT_COMMAND</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>

        <blockquote>
          <p>Tipsï¼šæ›´å¤šæ“ä½œè¯·æŸ¥çœ‹<code class="highlighter-rouge">JedisPubSub</code>ç±»çš„ç›¸å…³å±æ€§å’Œæ–¹æ³•</p>
        </blockquote>
      </li>
    </ul>
  </li>
</ul>

<h3 id="25-spring-å®ç°å‘å¸ƒè®¢é˜…æ¨¡å¼">2.5 Spring å®ç°å‘å¸ƒ/è®¢é˜…æ¨¡å¼</h3>

<ol>
  <li>
    <p>pom.xmlå¯¼å…¥ä¾èµ–åŒ…</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!-- Spring --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-beans<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-webmvc<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-jms<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-context-support<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>4.12<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.9.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework.data/spring-data-redis --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.data<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-data-redis<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.1.8.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.data<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-data-jpa<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.1.8.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.data<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-data-commons<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.1.8.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>springæ•´åˆrediså‘å¸ƒè®¢é˜…é…ç½®æ–‡ä»¶</p>

    <ol>
      <li>
        <p>redis.properties</p>

        <pre><code class="language-prop">redis.host=192.168.0.112
redis.port=6379
redis.maxIdle=30
redis.minIdle=10
redis.maxTotal=100
redis.maxWait=10000
redis.maxWaitMillis=1000
redis.blockWhenExhausted=true
redis.testOnBorrow=true
redis.db=0
</code></pre>
      </li>
      <li>
        <p>applicationContext-redis.xml</p>

        <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> 
       <span class="na">xmlns:p=</span><span class="s">"http://www.springframework.org/schema/p"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:jee=</span><span class="s">"http://www.springframework.org/schema/jee"</span> 
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xmlns:cache=</span><span class="s">"http://www.springframework.org/schema/cache"</span>
       <span class="na">xmlns:redis=</span><span class="s">"http://www.springframework.org/schema/redis"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/aop 
                           http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
                           http://www.springframework.org/schema/beans 
                           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                           http://www.springframework.org/schema/context 
                           http://www.springframework.org/schema/context/spring-context-3.0.xsd
									http://www.springframework.org/schema/jee
                           http://www.springframework.org/schema/jee/spring-jee-3.0.xsd
                           http://www.springframework.org/schema/tx 
                           http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
                           http://www.springframework.org/schema/redis 
                           http://www.springframework.org/schema/redis/spring-redis.xsd"</span>
       <span class="na">default-autowire=</span><span class="s">"byName"</span><span class="nt">&gt;</span>
      
    <span class="c">&lt;!-- åŠ è½½redisé…ç½® --&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:redis.properties"</span> <span class="nt">/&gt;</span>
      
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jedisPoolConfig"</span> <span class="na">class=</span><span class="s">"redis.clients.jedis.JedisPoolConfig"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxIdle"</span> <span class="na">value=</span><span class="s">"${redis.maxIdle}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minIdle"</span> <span class="na">value=</span><span class="s">"${redis.minIdle}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxWaitMillis"</span> <span class="na">value=</span><span class="s">"${redis.maxWait}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"testOnBorrow"</span> <span class="na">value=</span><span class="s">"${redis.testOnBorrow}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="c">&lt;!-- redisæœåŠ¡å™¨ä¸­å¿ƒ --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"connectionFactory"</span> 
          <span class="na">class=</span><span class="s">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span>
          <span class="na">p:host-name=</span><span class="s">"${redis.host}"</span> <span class="na">p:port=</span><span class="s">"${redis.port}"</span>
           <span class="na">p:database=</span><span class="s">"${redis.db}"</span> <span class="na">p:pool-config-ref=</span><span class="s">"jedisPoolConfig"</span><span class="nt">/&gt;</span>
      
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"redisTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.data.redis.core.RedisTemplate"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span> <span class="na">ref=</span><span class="s">"connectionFactory"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"keySerializer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.data.redis.serializer.StringRedisSerializer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"valueSerializer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.data.redis.serializer.JdkSerializationRedisSerializer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hashKeySerializer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.data.redis.serializer.StringRedisSerializer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hashValueSerializer"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.data.redis.serializer.JdkSerializationRedisSerializer"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="c">&lt;!--å¼€å¯äº‹åŠ¡  --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"enableTransactionSupport"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
      
    <span class="c">&lt;!-- å®šä¹‰Spring Redisçš„åºåˆ—åŒ–å™¨ --&gt;</span>
    <span class="c">&lt;!-- Stringåºåˆ—åŒ– --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"stringRedisSerializer"</span> 
          <span class="na">class=</span><span class="s">"org.springframework.data.redis.serializer.StringRedisSerializer"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- jdkåºåˆ—åŒ–--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jdkSerializer"</span> 
          <span class="na">class=</span><span class="s">"org.springframework.data.redis.serializer.JdkSerializationRedisSerializer"</span><span class="nt">/&gt;</span>
      
      
    <span class="c">&lt;!-- å°†ç›‘å¬å®ç°ç±»æ³¨å†Œåˆ°springå®¹å™¨ä¸­ --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"redisMessageListener"</span> <span class="na">class=</span><span class="s">"com.silhouette.listener.RedisMessageListener"</span><span class="nt">/&gt;</span>
      
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"topicContainer"</span>  
          <span class="na">class=</span><span class="s">"org.springframework.data.redis.listener.RedisMessageListenerContainer"</span>
          <span class="na">destroy-method=</span><span class="s">"destroy"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span> <span class="na">ref=</span><span class="s">"connectionFactory"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"taskExecutor"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"poolSize"</span> <span class="na">value=</span><span class="s">"3"</span><span class="nt">&gt;&lt;/property&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"messageListeners"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key-ref=</span><span class="s">"redisMessageListener"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.data.redis.listener.ChannelTopic"</span><span class="nt">&gt;</span>
                        <span class="c">&lt;!--channel--&gt;</span>
                        <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">"mychannel"</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>åœ¨web.xml æ–‡ä»¶ä¸­é…ç½®åŠ è½½springå®¹å™¨</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- åŠ è½½springå®¹å™¨ --&gt;</span>
<span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>classpath:spring/applicationContext-redis.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
<span class="nt">&lt;listener&gt;</span>
  	<span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>å‘å¸ƒæ¶ˆæ¯</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span><span class="o">=</span> <span class="o">{</span><span class="s">"classpath:spring/applicationContext-redis.xml"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageTest</span> <span class="o">{</span>
   
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
   
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRedis</span><span class="o">(){</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">redisTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">"mychannel"</span><span class="o">,</span> <span class="s">"ç¬¬"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"æ¬¡å‘é€ä¿¡æ¯"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//redisåšç¼“å­˜</span>
		  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="s">"silhouette"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>è®¢é˜…æ¶ˆæ¯</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisMessageListener</span>  <span class="kd">implements</span> <span class="nc">MessageListener</span> <span class="o">{</span>
   
    <span class="kd">protected</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
   
    <span class="kd">protected</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
   
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRedisTemplate</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">redisTemplate</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="o">}</span>
   
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">pattern</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span><span class="c1">// è¯·ä½¿ç”¨valueSerializer</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="c1">// è¯·å‚è€ƒé…ç½®æ–‡ä»¶ï¼Œæœ¬ä¾‹ä¸­keyï¼Œvalueçš„åºåˆ—åŒ–æ–¹å¼å‡ä¸ºstringã€‚</span>
        <span class="c1">// å…¶ä¸­keyå¿…é¡»ä¸ºstringSerializerå’ŒredisTemplate.convertAndSendå¯¹åº”</span>
        <span class="nc">String</span> <span class="n">itemValue</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">getValueSerializer</span><span class="o">().</span><span class="na">deserialize</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">topic</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">getStringSerializer</span><span class="o">().</span><span class="na">deserialize</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é¢‘é“ï¼š"</span> <span class="o">+</span> <span class="n">topic</span> <span class="o">+</span> <span class="s">"ï¼Œæ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹æ˜¯ï¼š"</span> <span class="o">+</span> <span class="n">itemValue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>è¿è¡Œæµ‹è¯•</p>

    <p><img src="/img/images/redis/02/16-Springæ•´åˆredis.png" /></p>
  </li>
</ol>

:ET